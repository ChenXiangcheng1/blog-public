<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>关系型数据库 | Nemesis</title><meta name="author" content="Nemesis,chenxiangcheng1@gmail.com"><meta name="copyright" content="Nemesis"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="主要是总结了MySQL8的索引模块和锁模块">
<meta property="og:type" content="article">
<meta property="og:title" content="关系型数据库">
<meta property="og:url" content="https://blog.haruharu.top/articles/Dev/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL8/">
<meta property="og:site_name" content="Nemesis">
<meta property="og:description" content="主要是总结了MySQL8的索引模块和锁模块">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_03_28_14_30.png">
<meta property="article:published_time" content="2023-03-28T16:00:00.000Z">
<meta property="article:modified_time" content="2024-05-26T14:19:50.843Z">
<meta property="article:author" content="Nemesis">
<meta property="article:tag" content="博客,ACM,技术,开发">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_03_28_14_30.png"><link rel="shortcut icon" href="/img/favicon48.ico"><link rel="canonical" href="https://blog.haruharu.top/articles/Dev/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL8/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":200,"languages":{"author":"作者: Nemesis","link":"链接: ","source":"来源: Nemesis","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '关系型数据库',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-05-26 22:19:50'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 23
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">69</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">34</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_03_28_14_30.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Nemesis"><span class="site-name">Nemesis</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">关系型数据库</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-03-28T16:00:00.000Z" title="发表于 2023-03-29 00:00:00">2023-03-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-05-26T14:19:50.843Z" title="更新于 2024-05-26 22:19:50">2024-05-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">16.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>65分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="关系型数据库"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>MySQL8</h1>
<p>目前很多Linux发行版用MariaDB<br>
关系型数据库首推postgresql</p>
<h2 id="文档">文档</h2>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/">Reference</a>	|	<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/dev/mysql-server/latest/">源码文档</a>	|	<a target="_blank" rel="noopener" href="https://github.com/mysql/mysql-server">github源码</a>	|	<a target="_blank" rel="noopener" href="https://downloads.mysql.com/archives/community/">官站源码</a>		<br>
TODO: 有空可以搭建 MySQL Debug 环境，调试源码</p>
<h2 id="1-关系型数据库管理系统架构">1 关系型数据库管理系统架构</h2>
<p>要设计一个关系型数据库，首先要将其划分成两大部分，一个是<strong>存储部分</strong>，该部分类似一个文件系统来将数据持久化到存储设备当中。那光有存储是不行的，还需要有<strong>程序实例</strong>部分来对存储进行逻辑上的管理，而程序实例部分包含将数据的逻辑关系转换成物理存储关系的<strong>1存储管理模块</strong>、优化执行效率的<strong>2缓存模块</strong>、将SQL语句进行解析的<strong>3SQL解析模块</strong>、记录操作的<strong>4日志管理模块</strong>、进行多用户管理的<strong>5权限划分模块</strong>、<strong>6灾难恢复模块</strong>、优化数据查询效率的<strong>7索引模块</strong>，以及使得数据库支持并发操作的<strong>8锁模块</strong>。</p>
<p><img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_03_28_14_30.png" alt="image-20230328143055209"></p>
<img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_05_08_21_53.png" alt="image-20230508215310783" style="zoom:80%;" />
<center>锁</center>
<h2 id="2索引模块">2索引模块</h2>
<p>如果WHERE子句中使用了索引，那么ORDER BY子句中不会使用索引</p>
<h3 id="2-1索引的作用">2.1索引的作用</h3>
<p>因为索引能让我们<strong>避免全表扫描，提升检索效率</strong>。(全表扫描将整张表的数据全部或者分批次加载到内存当中，再搜索不仅浪费内存还花费时间)</p>
<p>需要注意的是，索引并不是建立得越多越好：</p>
<p>数据量小的表不需要建立索引，建立会增加额外的<strong>索引开销</strong> (索引提高了查询速度，但不会提高更新表的速度，反而索引滥用会降低更新表的速度，导致更新、插入和删除等操作的性能下降)<br>
<strong>数据变更</strong>需要维护索引，因此更多的索引意味着更多的<strong>维护成本</strong><br>
更多的索引意味着也需要更多的<strong>空间</strong><br>
因此，在创建索引时需要根据具体的业务需求和数据库结构来选择合适的索引类型和索引列，避免过多或不必要的索引。</p>
<h3 id="2-2索引类型">2.2索引类型</h3>
<p>将能将记录限定在一定查找范围内的具有区分性的字段设置为索引</p>
<p><strong>普通索引</strong>：用于任何列，不限制列的唯一性</p>
<p><strong>唯一索引</strong>：限制列的唯一性</p>
<p><strong>主键索引</strong>：限制列的唯一性且不能为 NULL</p>
<p><strong>组合索引</strong>(联合索引)：用于多个列之间的联合查询</p>
<p><strong>全文索引</strong>：用于在大量的文本数据中进行关键字搜索</p>
<h3 id="2-3索引的数据结构">2.3索引的数据结构</h3>
<p><strong>主流是B±Tree、还有Hash结构、BitMap等</strong></p>
<h4 id="平衡二叉树或红黑树">平衡二叉树或红黑树</h4>
<p>无论是平衡二叉树还是红黑树每个节点包含一个关键字，且最多指向两棵子树，因此树的深度很大。<br>
在检索过程中，检索深度每增加1就会发生一次磁盘IO。</p>
<h4 id="B-Tree">B-Tree</h4>
<p>m阶B树(m&gt;=2)特征：</p>
<ol>
<li><strong>根节点至少包括两个孩子节点</strong></li>
<li><strong>除根节点和叶节点外</strong>，其他每个节点<strong>至少有<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⌈</mo><mi>m</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo stretchy="false">⌉</mo></mrow><annotation encoding="application/x-tex">\lceil m/2 \rceil</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">⌈</span><span class="mord mathnormal">m</span><span class="mord">/2</span><span class="mclose">⌉</span></span></span></span>个孩子节点</strong>。</li>
<li>树中每个节点<strong>最多含有m个孩子</strong></li>
<li>所有<strong>叶子节点</strong>都位于<strong>同一层</strong></li>
<li>假设每个非叶子结点中包含有n个关键字信息，其中
<ol>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mi>i</mi><mo>=</mo><mn>1...</mn><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">K_i(i=1...n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1...</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> 为关键字，且关键字按顺序<strong>升序</strong>排序<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mi>i</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>&lt;</mo><msub><mi>K</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">K_{i-1} &lt; K_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。</li>
<li>关键字的个数n必须满足：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⌈</mo><mrow><mi>m</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow><mo stretchy="false">⌉</mo><mo>−</mo><mn>1</mn><mo>&lt;</mo><mo>=</mo><mi>n</mi><mo>&lt;</mo><mo>=</mo><mi>m</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\lceil{m / 2}\rceil - 1 &lt;= n &lt;= m-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">⌈</span><span class="mord"><span class="mord mathnormal">m</span><span class="mord">/2</span></span><span class="mclose">⌉</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6835em;vertical-align:-0.0391em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></li>
<li>非叶子结点的指针：P[1], P[2]，…P[M]，其中P[1]指向关键字小于K[1]的子树，P[M]指向关键字大于K[M-1]的子树，其它<strong>P[i]指向关键字属于 (K[i-1]，K[i]) 的子树</strong></li>
</ol>
</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_03_28_15_20.png" alt="image-20230328152021902"></p>
<p>是一种更适合于应用在外存场景的数据结构</p>
<p>简单理解：m阶B树，每个节点都是多个关键字的有序表，且B树将更多内容放在同一个节点(每个节点都存储数据发生磁盘IO)，对同一个节点的操作转入内存中完成，减少磁盘操作，减少在外存中节点之间转移的次数，以达到提高效率的目的。</p>
<h4 id="B-Tree索引">B+Tree索引</h4>
<p>m阶B树(m&gt;=2)特征：</p>
<ol>
<li><strong>根节点至少包括两个孩子节点</strong></li>
<li><strong>除根节点和叶节点外</strong>，其他每个节点<strong>至少有<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⌈</mo><mrow><mi>m</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow><mo stretchy="false">⌉</mo></mrow><annotation encoding="application/x-tex">\lceil{m/2}\rceil</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">⌈</span><span class="mord"><span class="mord mathnormal">m</span><span class="mord">/2</span></span><span class="mclose">⌉</span></span></span></span>个孩子节点</strong></li>
<li>树中每个节点<strong>最多含有m个孩子</strong></li>
<li>所有叶子节点都位于同一层</li>
<li>假设每个非叶子结点中包含有n个关键字信息，其中
<ol>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mi>i</mi><mo>=</mo><mn>1...</mn><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">K_i (i=1...n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1...</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>为关键字，且关键字按顺序<strong>升序</strong>排序<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mi>i</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>&lt;</mo><msub><mi>K</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">K_{i-1} &lt; K_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。</li>
<li>非叶子节点的<strong>子树指针个数 =关键字的个数 n</strong></li>
<li>非叶子节点的子树指针<strong>P[i]指向关键字属于 [K[i，K[i+1]) 的子树</strong></li>
<li>非叶子节点仅用来索引，<strong>数据都保存在叶子节点中</strong></li>
<li>所有<strong>叶子节点</strong>均有一个<strong>链指针</strong>指向下一个叶子结点</li>
</ol>
</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_03_28_15_36.png" alt="image-20230328153650850"></p>
<p>B+Tree更适合用来做存储索引<br>
B+树的磁盘读写代价更低<br>
B+树的查询效率更加稳定<br>
B+树更有利于对数据库的扫描，即能优化范围查询</p>
<h4 id="Hash索引">Hash索引</h4>
<p><img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_03_28_15_59.png" alt="image-20230328155934144"></p>
<p>是哈希索引是索引键通过哈希运算，再将运算结果的哈希值和行指针信息存放在Buckets中。</p>
<p>缺点：<br>
仅仅能满足“=”，&quot;IN”，不能使用范围查询。因为哈希值大小关系和键值的不一致，所以<strong>只能等值过滤</strong>。<br>
无法被用来避免数据的排序操作<br>
不能利用部分索引键做查询。而B±Tree支持利用组合索引中的部分索引。<br>
不能避免表扫描。由于不同索引键可能存在相同哈希值，无法从哈希索引中直接完成查询，还是要访问Bucket中的数据进行实际的比较。<br>
遇到大量Hash值相等的情况性能并不一定就会比B-Tree索引高</p>
<h4 id="BitMap位图索引">BitMap位图索引</h4>
<p><img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_03_28_16_03.png" alt="image-20230328160327739"></p>
<h3 id="2-4密集索引和稀疏索引">2.4密集索引和稀疏索引</h3>
<p><img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_03_28_16_26.png" alt="image-20230328162600932"></p>
<ul>
<li>
<p>聚集索引文件：它将<strong>表中的每一行数据都映射到一个索引项上</strong>，索引项的数量与表中的行数相同。<br>
表的物理排列顺序决定了密集索引，所以<strong>一个表只能有一个密集索引</strong></p>
</li>
<li>
<p>稀疏索引文件：<strong>只包含表中部分行</strong>的索引项，索引项的数量远远小于表中的行数。<br>
使用非聚集索引<strong>需要两次IO操作</strong></p>
</li>
</ul>
<p><strong>MySQL8索引引擎：</strong></p>
<ul>
<li>InnoDB 支持聚集索引 (主键索引) 索引项存储了行数据，也支持稀疏索引 (辅助键索引) 索引项存储了行指针(<strong>主键值</strong>)<br>
InnoDB 的数据和索引存储在一块，在ibd文件中</li>
<li>MyISAM 只支持非聚集索引<br>
MyISAM 的索引存储在MYI，数据存储在MYD</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_03_28_21_28.png" alt="image-20230328212827291"></p>
<p><strong>不同索引树的查找过程：</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_03_28_16_27.png" alt="image-20230328162658827"></p>
<h4 id="InnoDB-的聚集索引选取规则：">InnoDB 的聚集索引选取规则：</h4>
<p>​		若一个<strong>主键primary</strong>被定义，该主键则作为密集索引<br>
​		若没有主键被定义，该表的<strong>第一个唯一非空索引unique</strong>则作为密集索引<br>
​		若不满足以上条件，innodb内部会生成一个<strong>隐藏主键</strong>(密集索引)<br>
​		非聚集索引(非主键索引)存储相关键位和其对应的主键值，包含两次查找。即非聚集索引(非主键索引)的叶子节点并不存储行数据的物理地址(行记录)，而是存储该行的主键值(行指针)</p>
<h3 id="2-5定位并优化慢查询SQL">2.5定位并优化慢查询SQL</h3>
<p><strong>第一步：根据慢日志定位慢查询sql</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%query%&#x27;</span>;  <span class="comment">-- 查看变量</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">GLOBAL</span> slow_query_log <span class="operator">=</span> <span class="keyword">ON</span>;  <span class="comment">-- 开启慢查询日志</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> long_query_time <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">--需要重新连接MySQL</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;%slow_queries%&#x27;</span>;  <span class="comment">-- 查看本次会话的慢SQL的条数</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 慢日志信息D:\Develop\mysql\mysql-8.0.32-winx64\data\DESKTOP-2DAQ5TI-slow.log</span><br><span class="line"># Time: 2023-03-29T11:54:01.606847+08:00</span><br><span class="line"># User@Host: root[root] @ localhost [::1]  Id:    19</span><br><span class="line"># Query_time: 1.691872  Lock_time: 0.000002 Rows_sent: 1164167  Rows_examined: 2328334</span><br><span class="line">SET timestamp=1680062039;</span><br><span class="line">SELECT `name` FROM person_info_large ORDER BY `name` DESC;</span><br></pre></td></tr></table></figure>
<p><strong>第二步：使用explain关键字等工具了解查询优化器如何执行查询</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_03_29_12_02.png" alt="image-20230329120251064"></p>
<ul>
<li>
<p>id字段：值越大执行优先级越高</p>
</li>
<li>
<p>type字段：其中all表示全表扫描SQL语句需要优化<br>
执行效率 system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; all</p>
</li>
<li>
<p>extra字段：出现以下2项意味着MYSQL根本不能使用索引,效率会受到重大影响。应尽可能对此进行优化。</p>
<ul>
<li>Using filesort：表示MySQL会对结果使用一个外部索引排序,而不是从表里按索引次序读到相关内容。可能在内存或者磁盘上进行排序。MySQL中无法利用索引完成的排序操作称为&quot;<em>文件排序</em>”</li>
<li>Using temporary：表示 MySQL在对查询结果排序时<em>使用临时表</em>。常见于排序order by和分组查询group by</li>
</ul>
</li>
<li>
<p>key字段：表示使用的索引字段</p>
</li>
</ul>
<p><strong>第三步：修改sql或者尽量让sql走索引</strong></p>
<ul>
<li><strong>修改查询语句</strong>：如尽量减少子查询、避免使用 “SELECT *” 等不必要的操作；</li>
<li><strong>优化索引</strong>：如增加或删除索引、优化索引顺序等；</li>
<li><strong>优化表结构</strong>：如拆分大表、优化表字段类型等；</li>
<li><strong>调整MySQL参数</strong>：如调整缓存大小、优化查询缓存、调整连接数等。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 可以修改<span class="keyword">sql</span>使用索引字段</span><br><span class="line"># 可以添加索引 <span class="keyword">alter</span> <span class="keyword">table</span> person_info_large <span class="keyword">add</span> index idx_name(name);</span><br><span class="line"># 可以用FORCE INDEX测试各种索引</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(id) <span class="keyword">FROM</span> person_info_large FORCE INDEX(<span class="keyword">PRIMARY</span>);</span><br></pre></td></tr></table></figure>
<p><strong>查询优化器</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_03_29_12_21.png" alt="image-20230329122101922"></p>
<p><img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_03_29_12_30.png" alt="image-20230329123038070"></p>
<p>MySQL 的查询优化器会尽可能使用严格索引 (主键索引 唯一索引) 来消除尽可能多的数据行，以减少查询的范围，提高查询效率。</p>
<p>InnoDB中 <code>count(id)</code> 使用 account 非聚集索引索引，而不是 id 主键聚集索引。分析：这是因为聚集索引的叶子节点存储完整的行数据，而非聚集索引只存储主键值，因此使用非聚集索引来计算count效果更好，所以MySQL查询优化器使用account索引。</p>
<h3 id="2-6组合索引的最左前缀匹配原则">2.6组合索引的最左前缀匹配原则</h3>
<ol>
<li><strong>查询优化器使用组合索引时，会一直沿着组合索引的列索引向右匹配直到遇到范围查询</strong>(&gt;、&lt;、between、like)<strong>就停止匹配</strong>。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select * from table1 where a = 3 and b = 4 and c &gt; 5 and d = 6;  - 其中a,b,d的顺序可以任意调整</span><br><span class="line"></span><br><span class="line">/*  若建立组合索引(a,b,c,d)，则不能使用d索引的</span><br><span class="line">	若建立组合索引(a,b,d,c)，则都可以用到 */</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><strong>对于SQL中的=和in查询列可以乱序</strong>，查询优化器会把SQL优化成索引可以识别的形式。</li>
</ol>
<p><strong>最左匹配原则的成因：</strong></p>
<img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_05_01_22_47.png" alt="image-20230501224707174" style="zoom:80%;" />
<center/>col3索引的B+Tree</center>
<p>因为B-Tree 节点内的关键字是有序的<br>
多字段排序：先按照一个字段排序，然后在该字段相同的情况下按照另一个字段排序。所以第一个字段<strong>绝对有序</strong>，之后的字段<strong>范围有序</strong>。</p>
<p>所以对于组合索引<code>(col1,col2,col3)</code>，想走col3索引之前必须先走col1和col2索引</p>
<h2 id="3锁模块">3锁模块</h2>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html">Reference#InnoDB Locking</a></p>
<h3 id="3-1MyISAM与InnoDB关于锁方面的区别是什么">3.1MyISAM与InnoDB关于锁方面的区别是什么</h3>
<h4 id="MyISAM">MyISAM</h4>
<ul>
<li>
<p>MyISAM 是 MySQL5.1 之前的默认引擎，支持稀疏索引</p>
<ul>
<li>
<p>MyISAM <strong>不支持事务</strong>，一条 SQL 跑完解锁</p>
</li>
<li>
<p>MyISAM 默认用的是<strong>表级锁</strong>，不支持行级锁</p>
</li>
</ul>
</li>
</ul>
<h5 id="表级锁">表级锁</h5>
<p>当对数据 SELECT 会自动加上表级读锁 (<strong>S共享锁</strong>)<br>
当对数据 增删改 会自动加上表级写锁 (<strong>X排他锁</strong>)</p>
<p>上共享锁后支持继续上共享锁，不支持排他锁</p>
<table>
<thead>
<tr>
<th>Session1\Session2</th>
<th>S共享锁</th>
<th>X排他锁</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>S共享锁</strong></td>
<td>兼容</td>
<td>冲突</td>
</tr>
<tr>
<td><strong>X排他锁</strong></td>
<td>冲突</td>
<td>冲突</td>
</tr>
</tbody>
</table>
<h5 id="MyISAM-适合的场景">MyISAM 适合的场景</h5>
<ol>
<li><strong>频繁执行全表 count 语句</strong>。因为 MyISAM 用变量保存行数，InnoDB 不保存行数</li>
<li>对数据进行<strong>增删改的频率不高</strong>，查询非常频繁。因为增删改要锁表</li>
<li><strong>没有事务</strong></li>
</ol>
<h4 id="InnoDB">InnoDB</h4>
<ul>
<li>
<p>InnoDB 是 MySQL5.1 之后的默认引擎支持事务和外键</p>
<ul>
<li>
<p>InnoDB <strong>支持事务</strong>，事务 commit 完解锁</p>
</li>
<li>
<p>InnoDB 默认用的是<strong>行级锁</strong>，也支持表级锁<br>
当 SQL 用到<strong>索引</strong>则会根据索引值上锁为<strong>行级锁</strong> (锁的细度越细代价越高)，<strong>没有索引</strong>上锁为<strong>表级锁</strong><br>
当对数据 select 默认为非阻塞 select 为<strong>快照读</strong> 不加锁、<code>SELECT * FROM table1 LOCK IN SHARE MODE;  -- 行级共享读锁</code>为<strong>当前读</strong></p>
</li>
</ul>
</li>
</ul>
<h5 id="意向锁">意向锁</h5>
<p><strong>意向锁</strong>是一种<strong>不与行级锁冲突的表级锁</strong>，表示想上锁，为数据行加共享/排他锁之前，InooDB 会先获取该数据行所在在数据表的对应意向锁。<br>
<strong>作用：上表锁时不必逐个检查行锁</strong></p>
<table>
<thead>
<tr>
<th>意向锁 Session1\Session2</th>
<th>IS共享意向锁</th>
<th>IX排他意向锁</th>
</tr>
</thead>
<tbody>
<tr>
<td>IS</td>
<td>兼容</td>
<td>兼容</td>
</tr>
<tr>
<td>IX</td>
<td>兼容</td>
<td>兼容</td>
</tr>
<tr>
<td>**行级锁与意向锁 Session1\Session2 **</td>
<td></td>
<td></td>
</tr>
<tr>
<td>S行共享</td>
<td>兼容</td>
<td>兼容</td>
</tr>
<tr>
<td>X行排他</td>
<td>兼容</td>
<td>兼容</td>
</tr>
<tr>
<td>**表级锁与意向锁 Session1\Session2 **</td>
<td></td>
<td></td>
</tr>
<tr>
<td>S表共享</td>
<td>兼容</td>
<td>冲突</td>
</tr>
<tr>
<td>X表排他</td>
<td>冲突</td>
<td>冲突</td>
</tr>
</tbody>
</table>
<h5 id="InnoDB适合的场景">InnoDB适合的场景</h5>
<ol>
<li>数据<strong>增删改查频繁</strong>。因为增删改只锁行</li>
<li>可靠性要求比较高，要求<strong>支持事务</strong></li>
<li><strong>并发性能更高</strong></li>
</ol>
<h4 id="锁的分类">锁的分类</h4>
<p>获取锁 acquire、释放锁 release</p>
<h5 id="按锁的粒度划分">按锁的粒度划分</h5>
<ul>
<li>行级锁</li>
<li>页级锁(BDB引擎)</li>
<li>表级锁</li>
</ul>
<h5 id="按锁的级别划分">按锁的级别划分</h5>
<p>共享锁(Shared Lock)：读锁</p>
<p>排它锁(Exclusive Lock)：写锁</p>
<p>互斥锁(Mutex Lock)：独占锁	<a href="../Java/%E7%B1%BB%E5%BA%93APIs/Java%E7%BA%BF%E7%A8%8B.md#%E4%BA%92%E6%96%A5%E9%94%81">Java线程笔记#互斥锁</a></p>
<h5 id="按锁的获取方式划分">按锁的获取方式划分</h5>
<p>自动锁：通过某种机制在特定范围内自动获取和释放锁</p>
<p>显式锁</p>
<h5 id="按锁的用途划分">按锁的用途划分</h5>
<p>DML 锁：数据操作语言</p>
<p>DDL 锁：数据定义语言</p>
<h5 id="按并发控制策略划分-默认">按并发控制策略划分(默认)</h5>
<p>乐观锁和悲观锁可以结合使用：锁升级策略</p>
<h6 id="乐观锁">乐观锁</h6>
<p>假设大多数情况下，事务之间不会发生并发冲突。</p>
<p>乐观锁不会阻塞其他事务的读取或写入操作。只在事务提交时检查是否有其他事务对资源进行了修改，若<strong>检测到冲突</strong>则当前事务回滚并<strong>重试</strong>(自旋)。</p>
<p>应用场景：并发读取频繁，并发写入少的场景</p>
<p>优点：不会阻塞读操作、可以减少锁的开销，并发<strong>性能更好</strong><br>
缺点：不能确保数据的一致性</p>
<p>实现：版本号(时间戳、哈希) 或 CAS(Compare And Swap) <a href="../Java/%E7%B1%BB%E5%BA%93APIs/Java%E7%BA%BF%E7%A8%8B.md#CAS">Java线程笔记#CAS</a><br>
版本号：version 字段表示数据是否过期，事务提交之前需要先检查 version 再更新 version++</p>
<h6 id="悲观锁">悲观锁</h6>
<p>假设大多数情况下，事务之间会发生并发冲突。</p>
<p>悲观锁在访问资源之前需要<strong>获取锁</strong>，并在事务结束之前一直持有锁，会阻塞其他事务对资源的读取或写入。</p>
<p>应用场景：并发写入频繁的场景</p>
<p>优点：能够确保数据的<strong>一致性</strong><br>
缺点：存在锁开销，并发性能低</p>
<h3 id="3-2事务的四大特性-ACID">3.2事务的四大特性 ACID</h3>
<p>**transaction：**事务，指一系列要么完全执行要么完全不执行的操作，维护了 ACID 特性。操作没有事务则不提供原子性和隔离性保证。<br>
事务，指完成某个业务功能所需的一系列操作</p>
<p><strong>ACID：</strong></p>
<ul>
<li>
<p><strong>原子性</strong> (atomicity [əˈtɑːmɪk])：一个事务是一个不可分割的工作单位。</p>
<ul>
<li>原子性：结构上，我的事务只有两种状态，<strong>全部执行成功和全部回滚</strong> (核心)</li>
<li>Spring 事务原子性：结构上，我的事务只有两种状态，执行和不执行，最主要</li>
<li>实现：undo log：回滚日志，记录修改前的“具体值”，实现事务Rollback</li>
</ul>
</li>
<li>
<p><strong>一致性</strong> (consistency [kənˈsɪstənsi])：一事务必须是使数据库从一个一致性状态变到另一个一致性状态。</p>
<ul>
<li>一致性：逻辑上，要维护数据<strong>逻辑关系的正确和完整</strong>，没有矛盾。在事务开始和结束时，数据应该处于一致的状态。</li>
<li>Spring 事务一致性：业务上，不能有不<strong>符合业务规则</strong>的变化，业务要是合理的</li>
</ul>
</li>
<li>
<p><strong>隔离性</strong> (isolation [ˌaɪsəˈleɪʃn])：指并发事务的隔离程度。多个<strong>并发事务执行时</strong>，它们之间<strong>是相互隔离的</strong>，一个事务的执行不应该受到其他事务的干扰。</p>
<ul>
<li>隔离性：并发上，两个事务是不能互相干扰的，每个事务看到的数据应该是一致的，<strong>不能出现并发读取数据时，读取到了其他未提交的事务的数据</strong>的情况。通过加锁解决。MySQL具体分为4种隔离级别</li>
<li>Spring 事务隔离性：<strong>并发时</strong>，两个事务<strong>互不干扰</strong>的。每个事务看到的数据应该是一致的，不能出现并发读取数据时，读取到了其他未提交的事务的数据的情况。通过加锁解决。Spring事务具体分为5种隔离级别</li>
</ul>
</li>
<li>
<p><strong>持久性</strong> (durability [ˌdʊrəˈbɪləti])：一旦事务提交成功，它对数据库中数据的改变就应该是永久性的。</p>
<ul>
<li>持久性：一旦事务提交成功，其所做的修改将会<strong>永久保存在数据库中</strong>，即使在之后的时间里发生了系统故障或断电等异常情况，数据也不应该丢失。InnoDB 使用 <strong>redo log(重做日志) 写前日志</strong>记录数据库修改操作，在数据库故障时重新执行保证了持久性。</li>
<li>Spring 事务持久性，一旦事务<strong>提交成功</strong>，其结果要同步到<strong>持久化</strong>控件中</li>
<li>实现：redo log：重做日志，记录修改后的“具体值”</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>Redo log 数据库写操作日志</th>
<th>Bin log 逻辑日志</th>
</tr>
</thead>
<tbody>
<tr>
<td>应用场景</td>
<td>崩溃恢复未落盘的数据，保证已提交事务的持久性</td>
<td>主从复制和数据恢复</td>
</tr>
<tr>
<td>实现方式</td>
<td>redo log是InnoDB引擎实现的，并不是所有引擎都有。</td>
<td>bin log是Server层(SQL语句分析、优化)实现的，所有引擎可用</td>
</tr>
<tr>
<td>记录的方式</td>
<td>redo log采用循环写的方式记录数据，日志记录落盘后会被覆盖掉，有写指针和数据落盘指针</td>
<td>bin log通过追加的方式记录，当文件大小大于max_binlog_size值后，后续的日志会记录到新文件上。</td>
</tr>
<tr>
<td>文件大小</td>
<td>redo log的大小是固定的</td>
<td>通过max_binlog_size配置</td>
</tr>
<tr>
<td>提交时机</td>
<td>逐步写入磁盘</td>
<td>一次性</td>
</tr>
<tr>
<td></td>
<td>innodb_flush_log_at_trx_commit<br />0 - 延迟写，崩溃时丢失1秒数据<br />1 - 实时写，实时刷<br />2 - 实时写，延迟刷，崩溃时丢失1秒数据</td>
<td></td>
</tr>
</tbody>
</table>
<p>两段提交，写完redo log再写binlog，任何一次提交失败都回滚，保证持久性</p>
<h4 id="并发访问问题">并发访问问题</h4>
<table>
<thead>
<tr>
<th>并发问题</th>
<th>释义</th>
<th>如何避免</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>更新丢失</strong></td>
<td>指多个事务对同一数据进行更新时，其中一个事务的<strong>更新被</strong>另一个事务的更新所<strong>覆盖</strong>，导致数据的更新结果丢失的情况。</td>
<td>通过互斥锁解决</td>
</tr>
<tr>
<td><strong>读操作并发问题</strong></td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>脏读</strong></td>
<td><strong>读未提交</strong></td>
<td>1. RC RR SERIALIZABLE<br />通过只能读持久化数据(快照读)不能读缓存解决</td>
</tr>
<tr>
<td><strong>不可重复读</strong></td>
<td>指在同一事务中，对同一数据进行<strong>多次查询，得到的结果不一致</strong>的情况。侧重于对同一事物的修改，<strong>读取与修改不隔离</strong></td>
<td>1. RR SERIALIZABLE (只有第一次快照读会创建一个 Read View 读视图，避免了上锁，推荐)<br />2. 使用行级共享读锁<strong>锁行</strong>(不建议)</td>
</tr>
<tr>
<td><strong>幻读</strong></td>
<td>指在同一事务中，对同一数据进行<strong>多次查询，得到的结果不一致</strong>的情况。侧重于新增或者删除，<strong>读取与增删不隔离</strong></td>
<td>1. SERIALIZABLE <br />2. RR 使用<code>SELECT * FROM account_innodb LOCK IN SHARE MODE;</code>上行级共享读锁<strong>锁表</strong></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>更新丢失</strong></p>
<img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_05_08_16_43.png" alt="image-20230508164334907" style="zoom: 50%;" />
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">START TRANSACTION;  -- 1</span><br><span class="line">UPDATE `account innodb` SET balance = balance+1 where id = 1;  -- 1</span><br><span class="line">COMMIT;  -- 2</span><br><span class="line">------------------------------------------------------------------------------------</span><br><span class="line">START TRANSACTION;  -- 1</span><br><span class="line">UPDATE `account innodb` SET balance = balance+2 where id = 1;  -- 1</span><br><span class="line">ROLLBACK;  -- 3</span><br></pre></td></tr></table></figure>
<p><strong>脏读</strong></p>
<img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_03_20_10_29.png" alt="1602415650743" style="zoom:50%;" />
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">START TRANSACTION;  -- 1</span><br><span class="line">SELECT * FROM `account innodb` WHERE id = 1;  -- 2</span><br><span class="line">COMMIT;  -- 3</span><br><span class="line">--------------------------------</span><br><span class="line">START TRANSACTION;  -- 1</span><br><span class="line">UPDATE `account innodb` SET balance = balance+1 WHERE id = 1;  -- 1</span><br><span class="line">ROLLBACK;  -- 3</span><br></pre></td></tr></table></figure>
<p><strong>不可重复度</strong></p>
<img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_03_20_10_31.png" alt="1602415667068" style="zoom:50%;" />
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-- 不可重复读</span><br><span class="line">START TRANSACTION;  -- 1</span><br><span class="line">SELECT * FROM `account innodb` WHERE id = 1;  -- 1  -- 快照读</span><br><span class="line">SELECT * FROM `account innodb` WHERE id = 1;  -- 3</span><br><span class="line">COMMIT;  -- 3</span><br><span class="line">--------------------------------</span><br><span class="line">START TRANSACTION;  -- 1</span><br><span class="line">UPDATE `account innodb` SET balance = balance+1 WHERE id = 1;  -- 2</span><br><span class="line">COMMIT;  -- 2</span><br><span class="line">-- 使用RR隔离级别下，解决不可重复读，此时读快照，改当前读</span><br></pre></td></tr></table></figure>
<p><strong>幻读</strong></p>
<img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_03_20_10_30.png" alt="1602415694379" style="zoom:50%;" />
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">-- RC下发生幻读</span><br><span class="line">START TRANSACTION;  -- 1</span><br><span class="line">SELECT * FROM `account innodb`;  -- 1</span><br><span class="line">UPDATE `account innodb` SET balance = 100;  -- 3  </span><br><span class="line">SELECT * FROM `account innodb`;  -- 1  当前读之后再执行快照读，会发生幻读，多修改了一条数据</span><br><span class="line">COMMIT;  -- 3 </span><br><span class="line">-- reaptable-read 下避免幻读</span><br><span class="line">START TRANSACTION;  -- 1</span><br><span class="line">SELECT * FROM `account innodb` LOCK IN SHARE MODE;  -- 1  -- 行级共享读锁，避免幻读</span><br><span class="line">UPDATE `account innodb` set xx=xx;  -- 3 </span><br><span class="line">SELECT * FROM `account innodb`;</span><br><span class="line">COMMIT;  -- 4</span><br><span class="line">-- Sserializable下解决幻读</span><br><span class="line">START TRANSACTION;  -- 1</span><br><span class="line">SELECT * FROM `account innodb`;  -- 1</span><br><span class="line">COMMIT;  -- 3</span><br><span class="line">--------------------------------</span><br><span class="line">-- 幻读</span><br><span class="line">START TRANSACTION;  -- 1</span><br><span class="line">INSERT INTO `account innodb` VALUES(14, &quot;newman&quot;, 500);  -- 2</span><br><span class="line">select * FROM `account innodb`;</span><br><span class="line">COMMIT;  -- 2</span><br></pre></td></tr></table></figure>
<h4 id="事务隔离级别-隔离性的具体体现">事务隔离级别(隔离性的具体体现)</h4>
<table>
<thead>
<tr>
<th>事务隔离级别</th>
<th>脏读</th>
<th>不可重复度</th>
<th>幻读</th>
<th>实现方式 (伪MVCC 机制)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>RU</strong> read-uncommitted</td>
<td>会</td>
<td>会</td>
<td>会</td>
<td></td>
</tr>
<tr>
<td><strong>RC</strong> read-committed (Oracle默认)</td>
<td></td>
<td>会</td>
<td>会</td>
<td>在 RC 级别事务的执行过程中，<strong>每次快照读会创建新的 Read View 读视图</strong> (Read View 决定了能读取哪个版本的数据快照)，所以是读已提交且会发生不可重复读。</td>
</tr>
<tr>
<td><strong>RR</strong> repeatable-read (MySQL默认)</td>
<td></td>
<td></td>
<td>会(部分场景可避免)<br /><code>SELECT * FROM table1 LOCK IN SHARE MODE;  -- 行级共享读锁 锁表</code>在查询时会对相应的记录加锁，阻止其他事务的增删操作(解决幻读)</td>
<td>在 RR 级别事务的执行过程中，<strong>只有第一次快照读会创建一个 Read View 读视图</strong> (Read View 决定了能读取哪个版本的数据快照) (所以RR级别下什么时候首次使用快照读很重要)，其他并发事务对于已经存在的数据进行修改时并不会影响到当前事务的快照，所以不会发生不可重复读。但是其他并发事务对于当前事务还不存在的数据进行修改则会影响到当前事务的快照，所以会发生幻读。<br /><strong>Gap 锁</strong>在部分场景避免了幻读<br /></td>
</tr>
<tr>
<td><strong>serializable</strong> [/ˈsɪˌriəˌlaɪzəbl/]</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-- 事务隔离级别</span><br><span class="line">SET SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;</span><br><span class="line">SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;</span><br><span class="line">SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;</span><br><span class="line">SET SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE;</span><br><span class="line">SELECT @@GLOBAL.transaction_isolation, @@transaction_isolation, @@session.transaction_isolation;</span><br></pre></td></tr></table></figure>
<h4 id="3-3当前读和快照读">3.3当前读和快照读</h4>
<ul>
<li>当前读：读最新版本数据</li>
</ul>
<p><strong>加锁的</strong> 阻塞的</p>
<p>通过 next-key 锁实现，解决幻读问题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select * from table1 lock in share mode  -- 行级共享锁</span><br><span class="line">select * from table1 for update  -- 行级排他锁</span><br><span class="line">update、delete、insert</span><br></pre></td></tr></table></figure>
<ul>
<li>快照读：读事务快照版本数据</li>
</ul>
<p><strong>不加锁的</strong> 非阻塞的</p>
<p>通过 Read View 实现，解决读操作并发问题。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from table1  // RU、RC、RR级别下</span><br></pre></td></tr></table></figure>
<h5 id="3-4Undo撤销日志-Read-View-实现快照读">3.4Undo撤销日志 + Read View 实现快照读</h5>
<p>next-key 锁</p>
<p>undo log：回滚日志，记录修改前的“具体值”，实现事务Rollback</p>
<p><strong>快照读的实现：</strong></p>
<table>
<thead>
<tr>
<th>数据行隐藏字段</th>
<th>释义</th>
</tr>
</thead>
<tbody>
<tr>
<td>DB_TRX ID</td>
<td>事务ID，越新开启的事务ID越大</td>
</tr>
<tr>
<td>DB_ROLL_PTR</td>
<td>回滚指针指向旧版本的 Undo Log</td>
</tr>
<tr>
<td>DB_ROW_ID</td>
<td>行ID，隐藏备用主键字段</td>
</tr>
</tbody>
</table>
<img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_05_08_22_29.png" alt="image-20230508222937952" style="zoom: 80%;" />
<ul>
<li>
<p>Undo Log 链：<strong>记录数据修改之前的副本</strong>(因为多版本记录是串行的，不是共存的，所以是伪 MVCC)</p>
<ul>
<li>Insert Undo Log 链，是在<strong>insert</strong>操作中产生的 Undo Log。因为insert操作的记录只对当前事务本身可见，对于其它事务此记录是不可见的，所以insert undo log在事务提交后直接删除。</li>
<li>Update Undo Log 链，是在update/delete操作中产生的 Undo Log。事务回滚时需要，快照读需要，在快照不涉及该日志才删除</li>
</ul>
</li>
<li>
<p>Read View 读视图：是一个逻辑数据结构，它包含了已提交事务ID列表和当前活跃事务ID列表，根据已提交事务ID列表来决定读取哪个版本的数据快照(使用可见行算法来判断数据行是否对该事务是可见的)。Read View 在事务开始时创建，快照读取时更新。</p>
<ul>
<li>可见性算法：若数据行的事务ID大于当前Read View事务ID，则说明数据行是在当前事务开始之后提交的对当前事务不可见，通过DB_ROLL_PTR指针取出Undo Log，直到数据行的事务ID小于等于当前Read View事务ID。</li>
</ul>
</li>
</ul>
<p>在<strong>伪 MVCC 多版本并发控制机制</strong>中，在事务开始时创建一个初始版本的 Read View 读视图用于记录已提交事务ID列表和当前活跃事务ID列表。当事务修改一条数据时，它会创建该数据的新版本，而不是修改现有的数据，这个新版本会被记录一个新的版本号。当事务读取数据时，会根据已提交事务ID列表和记录的版本号(事务ID)来判断是否可以读取该记录。</p>
<p>在 RC 级别事务的执行过程中，<strong>每次快照读会创建新的 Read View 读视图</strong> (Read View 决定了能读取哪个版本的数据快照)，所以是读已提交且过程中，<strong>只有第一次快照读会创建一个 Read View 读视图</strong> (Read View 决定了能读取哪个版本的数据快照) (<strong>所以RR级别下什么时候首次使用快照读很重要</strong>)，其他并发事务对于已经存在的数据进行修改时并不会影响到当前事务的快照，所以不会发生不可重复读。<strong>但是其他并发事务对于当前事务还不存在的数据进行修改则会影响到当前事务的快照，所以会发生幻读。</strong></p>
<p>MVCC作用：读操作不加锁，<strong>用于实现读写并发和事务的隔离性</strong></p>
<h5 id="3-5当前读的next-key锁">3.5当前读的next-key锁</h5>
<p>表象：基于伪 MVCC 机制实现快照读</p>
<p>内在：RR 级别下实现了<strong>next-key锁</strong> (record记录锁 + Gap锁(用于防止插入))，从而<strong>在RR级别下部分场景避免了幻读</strong></p>
<p>RR级别下的走<strong>主键索引</strong>或<strong>唯一索引</strong>的<strong>当前读</strong>的next-key锁机制：</p>
<blockquote>
<p>InnoDB RR级别主要通过引入 next-key 锁来避免下幻读问题</p>
<p>next-key 锁由 record 锁和 Gap 锁组成</p>
<p>Gap 锁会用在：非唯一索引或者不走索引的当前读，以及[仅命中检索条件的部分结果集]并且[用到主键索引或唯一索引]的当前读中。</p>
</blockquote>
<ul>
<li>若where条件<strong>全部命中</strong>，则只会上行级锁 (若是非主键索引，则需要对当前索引和主键索引都上锁)<br>
因为语义上全命中且唯一，所以不需要 Gap 锁</li>
</ul>
<img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_05_09_17_54.png" alt="image-20230509175429758" style="zoom:67%;" />
<ul>
<li>若where条件<strong>部分命中</strong>或者<strong>全不命中</strong>，则会上行级锁和 (左开右闭区间) Gap锁</li>
</ul>
<p>RR级别下走<strong>非唯一索引</strong>或<strong>不走索引</strong>的<strong>当前读</strong>的next-key锁机制</p>
<ul>
<li><strong>非唯一索引</strong>：上Gap锁，且使用主键达到更准确的区间</li>
</ul>
<img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_05_09_16_14.png" alt="image-20230509161416233" style="zoom:80%;" />
<center/>Gap 锁区间: [6c,9b) [9b9d) [9d,11f) (使用主键达到更准确的区间)</center>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">insert into tb1 values(&#x27;bb&#x27;, 6);  -- success</span><br><span class="line">insert into tb1 values(&#x27;cc&#x27;, 6);  -- block</span><br><span class="line">insert into tb1 values(&#x27;ee&#x27;, 11);  -- block</span><br><span class="line">insert into tb1 values(&#x27;ff&#x27;, 11);  -- success</span><br><span class="line"></span><br><span class="line">utf8mb4_0900_ai_ci的排序规则：1, ab, abc, ac, b, bb, c</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>不走索引</strong>：对所有Gap上锁=锁表 (<strong>这种情况需要避免，代价太大</strong>)</li>
</ul>
<img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_05_09_16_12.png" alt="image-20230509161203585" style="zoom:67%;" />
<h2 id="4语法SQL">4语法SQL</h2>
<h3 id="系统变量和状态变量">系统变量和状态变量</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show [global|session(default)] &#123;variables|status&#125; [like &#x27;%str%&#x27;]</span><br><span class="line">set [global|session(default)] &#123;variable_key&#125; = &#123;variable_value&#125;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html">https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html</a></p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>释义</th>
</tr>
</thead>
<tbody>
<tr>
<td>autocommit</td>
<td></td>
</tr>
<tr>
<td>character_set_client</td>
<td>设置mysql返回的字符编码，解决cmd和mysql编码不同而中文乱码</td>
</tr>
<tr>
<td>long_query_time</td>
<td>需要重新连接客户端</td>
</tr>
<tr>
<td>slow_query</td>
<td></td>
</tr>
<tr>
<td>slow_query_log</td>
<td>MySQL服务开启慢查询日志</td>
</tr>
<tr>
<td>transaction_isolation</td>
<td>查询全事务隔离级别</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/server-status-variables.html">https://dev.mysql.com/doc/refman/8.0/en/server-status-variables.html</a></p>
<table>
<thead>
<tr>
<th>Status</th>
<th>释义</th>
</tr>
</thead>
<tbody>
<tr>
<td>engines</td>
<td>查看服务器支持的引擎</td>
</tr>
<tr>
<td>%query%</td>
<td>模糊查询和slow_query有关的变量</td>
</tr>
<tr>
<td>%slow_queries%</td>
<td>查看本次会话的慢SQL的条数</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="4-1DML">4.1DML</h3>
<h4 id="注释">注释</h4>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 行注释</span></span><br><span class="line"><span class="comment">/* 块注释 */</span></span><br></pre></td></tr></table></figure>
<h4 id="SELECT">SELECT</h4>
<h5 id="关联查询">关联查询</h5>
<p>笛卡尔积CROSS JOIN：将每个表的每一行与其他表的每一行组合<br>
连接查询 = 笛卡尔积 + where条件过滤<br>
所以实际项目中建议使用单表查询再用 Java 逻辑封装(将计算放到Service层减轻数据库压力、减少锁的竞争、解耦更容易对数据库扩展)或者采用不超过三次的显式join查询(因为没索引关联结果会爆炸式增长)<br>
需要保证被关联的字段需要有索引</p>
<p>1隐式内连接：<code>from tb_n1,tb_n2 where tb_n1.id = tb_n2.id</code>，</p>
<p>2内连接：<code>tb_n1 join tb_n2 on tb_n1.id = tb_n2.id</code></p>
<p>3左外连接：<code>tb_n1 left join tb_n2 on tb_n1.id = tb_n2.id</code>：返回左表中的所有行，以及与右表匹配的行，如果在右表中没有匹配的行，则右表的列将为 NULL。</p>
<p>4右外连接：<code>tb_n1 right join tb_n2 on tb_n1.id = tb_n2.id</code>：返回右表中的所有行，以及与左表匹配的行，如果在左表中没有匹配的行，则左表的列将为 NULL。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select se.*, stu.name sname, cou.name cname from selection se left join student stu on se.student=stu.id left join course cou on se.course=cou.id where course = xxx</span><br></pre></td></tr></table></figure>
<h6 id="笔试">笔试</h6>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/fc7344ece7294b9e98401826b94c6ea5?tpId=82&amp;tqId=29773&amp;rp=1&amp;ru=/exam/interview&amp;qru=/exam/interview&amp;sourceUrl=%2Fexam%2Finterview%3Forder%3D0&amp;difficulty=5&amp;judgeStatus=undefined&amp;tags=&amp;title=">题目1</a>：查找在职员工自入职以来的薪水涨幅情况</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 内连接方式：两种时间空间差不多，但这种更直观</span></span><br><span class="line"><span class="keyword">SELECT</span> a.emp_no, (b.salary <span class="operator">-</span> c.salary) <span class="keyword">as</span> growth</span><br><span class="line"><span class="keyword">FROM</span> employees <span class="keyword">AS</span> a</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> salaries <span class="keyword">AS</span> b <span class="keyword">ON</span> a.emp_no <span class="operator">=</span> b.emp_no <span class="keyword">AND</span> b.to_date <span class="operator">=</span> <span class="string">&#x27;9999-01-01&#x27;</span></span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> salaries <span class="keyword">AS</span> c <span class="keyword">ON</span> a.emp_no <span class="operator">=</span> c.emp_no <span class="keyword">AND</span> a.hire_date <span class="operator">=</span> c.from_date</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> growth;</span><br><span class="line"><span class="comment">-- 即</span></span><br><span class="line"><span class="keyword">SELECT</span> a.emp_no, (b.salary <span class="operator">-</span> c.salary) <span class="keyword">as</span> growth</span><br><span class="line"><span class="keyword">FROM</span> employees <span class="keyword">AS</span> a, salaries <span class="keyword">AS</span> b, salaries <span class="keyword">AS</span> c <span class="keyword">where</span> a.emp_no <span class="operator">=</span> b.emp_no <span class="keyword">AND</span> b.to_date <span class="operator">=</span> <span class="string">&#x27;9999-01-01&#x27;</span> <span class="keyword">and</span> a.emp_no <span class="operator">=</span> c.emp_no <span class="keyword">AND</span> a.hire_date <span class="operator">=</span> c.from_date</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> growth;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 自查询方式</span></span><br><span class="line"><span class="keyword">select</span> now_t.emp_no, now_sal <span class="operator">-</span> old_sal <span class="keyword">as</span> growth</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> emp.emp_no, salary <span class="keyword">as</span> now_sal</span><br><span class="line">    <span class="keyword">from</span> employees emp <span class="keyword">join</span> salaries <span class="keyword">as</span> sal <span class="keyword">on</span> emp.emp_no <span class="operator">=</span> sal.emp_no</span><br><span class="line">    <span class="keyword">where</span> to_date <span class="operator">=</span> <span class="string">&#x27;9999-01-01&#x27;</span></span><br><span class="line">) <span class="keyword">as</span> now_t <span class="keyword">join</span> (</span><br><span class="line">    <span class="keyword">select</span> emp.emp_no, salary <span class="keyword">as</span> old_sal</span><br><span class="line">    <span class="keyword">from</span> employees emp <span class="keyword">join</span> salaries <span class="keyword">as</span> sal <span class="keyword">on</span> emp.emp_no <span class="operator">=</span> sal.emp_no</span><br><span class="line">    <span class="keyword">where</span> from_date <span class="operator">=</span> hire_date</span><br><span class="line">) <span class="keyword">as</span> old_t <span class="keyword">on</span> now_t.emp_no <span class="operator">=</span> old_t.emp_no</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> growth;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/f858d74a030e48da8e0f69e21be63bef?tpId=82&amp;tqId=29777&amp;rp=1&amp;ru=/exam/interview&amp;qru=/exam/interview&amp;sourceUrl=%2Fexam%2Finterview%3Forder%3D0&amp;difficulty=5&amp;judgeStatus=undefined&amp;tags=&amp;title=">题目2</a>：获取员工其当前的薪水比其manager当前薪水还高的相关信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> emp.emp_no, dept.emp_no, e_sal.salary, m_sal.salary</span><br><span class="line"><span class="keyword">from</span> dept_emp <span class="keyword">as</span> emp </span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> dept_manager <span class="keyword">as</span> dept <span class="keyword">on</span> emp.dept_no <span class="operator">=</span> dept.dept_no <span class="keyword">and</span> emp.emp_no <span class="operator">!=</span> dept.emp_no</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> salaries <span class="keyword">as</span> e_sal <span class="keyword">on</span> emp.emp_no <span class="operator">=</span> e_sal.emp_no</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> salaries <span class="keyword">as</span> m_sal <span class="keyword">on</span> dept.emp_no <span class="operator">=</span> m_sal.emp_no</span><br><span class="line"><span class="keyword">where</span> e_sal.salary <span class="operator">&gt;</span> m_sal.salary;</span><br><span class="line"><span class="comment">-- 即</span></span><br><span class="line"><span class="keyword">select</span> emp.emp_no, dept.emp_no, e_sal.salary, m_sal.salary</span><br><span class="line"><span class="keyword">from</span> dept_emp <span class="keyword">as</span> emp, dept_manager <span class="keyword">as</span> dept, salaries <span class="keyword">as</span> e_sal, salaries <span class="keyword">as</span> m_sal</span><br><span class="line"><span class="keyword">where</span> emp.dept_no <span class="operator">=</span> dept.dept_no <span class="keyword">and</span> emp.emp_no <span class="operator">=</span> e_sal.emp_no <span class="keyword">and</span> dept.emp_no <span class="operator">=</span> m_sal.emp_no <span class="keyword">and</span> emp.emp_no <span class="operator">!=</span> dept.emp_no <span class="keyword">and</span> e_sal.salary <span class="operator">&gt;</span> m_sal.salary;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> emp_no, manager_no, emp_salary, manager_salary</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> emp.emp_no, salary <span class="keyword">as</span> emp_salary, emp.dept_no</span><br><span class="line">    <span class="keyword">from</span> dept_emp <span class="keyword">as</span> emp</span><br><span class="line">    <span class="keyword">inner</span> <span class="keyword">join</span> salaries <span class="keyword">as</span> sal </span><br><span class="line">    <span class="keyword">on</span> emp.emp_no <span class="operator">=</span> sal.emp_no) <span class="keyword">as</span> t1</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> (</span><br><span class="line">    <span class="keyword">select</span> dept.emp_no <span class="keyword">as</span> manager_no, salary <span class="keyword">as</span> manager_salary, dept.dept_no</span><br><span class="line">    <span class="keyword">from</span> dept_manager <span class="keyword">as</span> dept</span><br><span class="line">    <span class="keyword">inner</span> <span class="keyword">join</span> salaries <span class="keyword">as</span> sal</span><br><span class="line">    <span class="keyword">on</span> dept.emp_no <span class="operator">=</span> sal.emp_no) <span class="keyword">as</span> t2</span><br><span class="line"><span class="keyword">on</span> t1.dept_no <span class="operator">=</span> t2.dept_no <span class="keyword">and</span> emp_no <span class="operator">!=</span> manager_no</span><br><span class="line"><span class="keyword">where</span> emp_salary <span class="operator">&gt;</span> manager_salary;</span><br></pre></td></tr></table></figure>
<p>体会：对于小表<strong>使用关联查询更简洁</strong>，子查询麻烦</p>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/ea0c56cd700344b590182aad03cc61b8?tpId=82&amp;tqId=35088&amp;rp=1&amp;ru=/exam/oj&amp;qru=/exam/oj&amp;sourceUrl=%2Fexam%2Foj%3Fpage%3D1%26tab%3DSQL%25E7%25AF%2587%26topicId%3D240&amp;difficulty=5&amp;judgeStatus=undefined&amp;tags=&amp;title=">题目3</a>：牛客每个人最近的登录日期(五)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 我写的，复杂还错了</span></span><br><span class="line"><span class="keyword">select</span> t3.date, ifnull(round(t2.new_user_num<span class="operator">/</span>t1.next_new_user_num, <span class="number">3</span>), <span class="number">0</span>)</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span> l1.date, <span class="built_in">count</span>(l1.user_id) <span class="keyword">as</span> next_new_user_num  # 日期，新用户数量</span><br><span class="line">    <span class="keyword">from</span> login <span class="keyword">as</span> l1</span><br><span class="line">    <span class="keyword">where</span> (l1.date, l1.user_id) <span class="keyword">in</span> (</span><br><span class="line">        <span class="keyword">select</span> <span class="built_in">min</span>(l2.date), l2.user_id</span><br><span class="line">        <span class="keyword">from</span> login <span class="keyword">as</span> l2</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> l2.user_id)</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> l1.date) <span class="keyword">as</span> t1 </span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span></span><br><span class="line">    (<span class="keyword">select</span> today.date, <span class="built_in">count</span>(today.user_id) <span class="keyword">as</span> new_user_num  # 该子查询，有问题没确保是昨天新用户，只是昨天登录过的用户</span><br><span class="line">    <span class="keyword">from</span> login <span class="keyword">as</span> today</span><br><span class="line">    <span class="keyword">inner</span> <span class="keyword">join</span> login <span class="keyword">as</span> tomorrow</span><br><span class="line">    <span class="keyword">on</span> today.user_id <span class="operator">=</span> tomorrow.user_id <span class="keyword">and</span> datediff(tomorrow.date, today.date) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> today.date) <span class="keyword">as</span> t2</span><br><span class="line"><span class="keyword">on</span> t1.date <span class="operator">=</span> t2.date</span><br><span class="line"><span class="keyword">right</span> <span class="keyword">join</span></span><br><span class="line">    (<span class="keyword">select</span> l3.date</span><br><span class="line">    <span class="keyword">from</span> login <span class="keyword">as</span> l3</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> l3.date) <span class="keyword">as</span> t3</span><br><span class="line"><span class="keyword">on</span> t3.date <span class="operator">=</span> t1.date</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> t0.date,</span><br><span class="line">ifnull(round(<span class="built_in">count</span>(<span class="keyword">distinct</span> t2.user_id)<span class="operator">/</span>(<span class="built_in">count</span>(t1.user_id)),<span class="number">3</span>),<span class="number">0</span>)</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> <span class="type">date</span></span><br><span class="line">    <span class="keyword">from</span> login</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> <span class="type">date</span></span><br><span class="line">) t0</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> user_id,<span class="built_in">min</span>(<span class="type">date</span>) <span class="keyword">as</span> <span class="type">date</span></span><br><span class="line">    <span class="keyword">from</span> login</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> user_id</span><br><span class="line">)t1</span><br><span class="line"><span class="keyword">on</span> t0.date<span class="operator">=</span>t1.date</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> login <span class="keyword">as</span> t2</span><br><span class="line"><span class="keyword">on</span> t1.user_id<span class="operator">=</span>t2.user_id <span class="keyword">and</span> datediff(t2.date,t1.date)<span class="operator">=</span><span class="number">1</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> t0.date</span><br></pre></td></tr></table></figure>
<p>体会：要联表查询不要子查询，需要哪些信息就多left join进去，最后group by统计</p>
<h5 id="group-by-和-having-和聚合函数">group by 和 having 和聚合函数</h5>
<p><strong>group by</strong></p>
<p>每行为一个<strong>分组</strong>，配合聚合函数使用</p>
<ul>
<li>
<p><code>sql_mode=only_full_group_by</code>要求 SELECT 列表中<strong>检索的列必须为GROUP BY子句中的列或使用聚合函数进行计算</strong><br>
使用其他模式时会自动选一个值</p>
</li>
<li>
<p><strong>聚合函数</strong>对于group by子句定义的每个组各返回一个结果</p>
</li>
</ul>
<p><strong>having</strong></p>
<p>对每个分组进行<strong>聚合过滤</strong></p>
<ul>
<li>通常与 group by 子句一起使用</li>
<li>where<strong>过滤行</strong>，having<strong>过滤组</strong></li>
<li>出现在同一SQL中的前后顺序：where &gt; group by &gt; having</li>
</ul>
<p><strong>聚合函数</strong></p>
<p><code>sql_mode=only_full_group_by</code> 模式</p>
<table>
<thead>
<tr>
<th>聚合函数</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>min()</td>
<td></td>
<td></td>
</tr>
<tr>
<td>max()</td>
<td></td>
<td></td>
</tr>
<tr>
<td>count(Sname) <br/>count(常量)</td>
<td>计数非空行<br />计数每一行</td>
<td></td>
</tr>
<tr>
<td>avg()</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h6 id="笔试-2">笔试</h6>
<p>题目1：找出平均分在90以上且没有一门课在80分以下的学生学号</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> Sno </span><br><span class="line"><span class="keyword">from</span> S, SC <span class="keyword">where</span> S.Sno<span class="operator">=</span>SC.Sno</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> S.Sno </span><br><span class="line"><span class="keyword">having</span> <span class="built_in">avg</span>(grade) <span class="operator">&gt;=</span> <span class="number">90</span> <span class="keyword">and</span> <span class="built_in">min</span>(grade) <span class="operator">&gt;=</span> <span class="number">80</span>;</span><br></pre></td></tr></table></figure>
<p>题目2：查询没有学全所有课的同学的学号、姓名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT stu.student_id, stu.`name`, COUNT(course_id)</span><br><span class="line">FROM student stu, score s WHERE stu.student_id = s.student_id</span><br><span class="line">GROUP BY stu.student_id, stu.`name`</span><br><span class="line">HAVING COUNT(course_id) &lt; (</span><br><span class="line">	SELECT COUNT(course_id) FROM course</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h5 id="笔试-3">笔试</h5>
<p>题目1：在学生表S表中删除既不是物理系、信息系也不是计算机系的学生</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> S <span class="keyword">where</span> Sdept <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;物理系&#x27;</span>,<span class="string">&#x27;&#x27;</span>信息系<span class="string">&#x27;,&#x27;</span>计算机系<span class="string">&#x27;);</span></span><br></pre></td></tr></table></figure>
<p>题目2：找出所有不姓张的学生的姓名、性别及系科</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> Sname, Ssex, Sdept <span class="keyword">from</span> S <span class="keyword">where</span> Sname <span class="keyword">not</span> <span class="keyword">like</span> <span class="string">&#x27;张%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<h5 id="相关关键字">相关关键字</h5>
<table>
<thead>
<tr>
<th>查询子句</th>
<th>释义</th>
</tr>
</thead>
<tbody>
<tr>
<td>distinct</td>
<td></td>
</tr>
<tr>
<td>limit n,m</td>
<td>表示跳过n条后的m条记录</td>
</tr>
<tr>
<td>order by xx [asc(默认)|desc]</td>
<td>降序</td>
</tr>
<tr>
<td>like ‘%%’</td>
<td>%多个、_一个</td>
</tr>
<tr>
<td>in (value1,value2)</td>
<td></td>
</tr>
<tr>
<td>between value1 and value2</td>
<td></td>
</tr>
<tr>
<td>all()</td>
<td>常与&lt;,&gt;,=,!=配合使用</td>
</tr>
<tr>
<td>any()</td>
<td>常与&lt;,&gt;,=,!=配合使用</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>union</td>
<td>并集，将两个查询结果合并成一个结果集，要求列数和数据类型兼容，且不会列出重复的行</td>
</tr>
<tr>
<td>union all</td>
<td>并集，会列出重复的行</td>
</tr>
<tr>
<td>INTERSECT</td>
<td>交集</td>
</tr>
<tr>
<td>EXCEPT</td>
<td>差集</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>exists()</td>
<td>检查子查询是否返回任何行</td>
</tr>
</tbody>
</table>
<h5 id="窗口函数">窗口函数</h5>
<table>
<thead>
<tr>
<th>窗口函数</th>
<th>释义</th>
</tr>
</thead>
<tbody>
<tr>
<td>row_number()</td>
<td></td>
</tr>
<tr>
<td>dense_rank() over(order by score desc)</td>
<td>密集排序</td>
</tr>
<tr>
<td>now()</td>
<td>返回datetime类型的 <code>'YYYY-MM-DD HH:MM:SS'</code></td>
</tr>
<tr>
<td>DATEDIFF(d1,d2)</td>
<td></td>
</tr>
<tr>
<td>ifnull(xxx, 0)</td>
<td>若xxx=null，则返回0</td>
</tr>
</tbody>
</table>
<h4 id="INSERT">INSERT</h4>
<p>报错</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="comment">-- 如果表中已存在具有相同主键或唯一索引的行，则报错</span></span><br></pre></td></tr></table></figure>
<p>修改</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> employees (emp_no, first_name, last_name)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;John&#x27;</span>, <span class="string">&#x27;Doe&#x27;</span>)</span><br><span class="line"><span class="keyword">ON</span> DUPLICATE KEY <span class="keyword">UPDATE</span> first_name <span class="operator">=</span> <span class="string">&#x27;John&#x27;</span>, last_name <span class="operator">=</span> <span class="string">&#x27;Doe&#x27;</span>;  <span class="comment">-- 如果表中已存在具有相同主键或唯一索引的行，则UPDATE</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replace <span class="keyword">into</span>  <span class="comment">-- 如果表中已存在具有相同主键或唯一索引的行，则将旧行删除，并插入新行；不存在同INSERT INTO</span></span><br></pre></td></tr></table></figure>
<p>忽略</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> ignore  <span class="comment">-- 如果表中已存在具有相同主键或唯一索引的行，则忽略插入操作而不报错；不存在同INSERT INTO</span></span><br></pre></td></tr></table></figure>
<h5 id="笔试-4">笔试</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 批量插入</span><br><span class="line">insert into actor <span class="title function_">values</span><span class="params">(<span class="number">1</span>,<span class="string">&#x27;PENELOPE&#x27;</span>,<span class="string">&#x27;GUINESS&#x27;</span>,<span class="string">&#x27;2006-02-15 12:34:33&#x27;</span>)</span>,(<span class="number">2</span>,<span class="string">&#x27;NICK&#x27;</span>,<span class="string">&#x27;WAHLBERG&#x27;</span>,<span class="string">&#x27;2006-02-15 12:34:33&#x27;</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 了解</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> table_name <span class="keyword">values</span>(c1,c2),(c11,c22) <span class="keyword">on</span> duplicate key <span class="keyword">update</span> c1<span class="operator">=</span><span class="number">123</span>,c2<span class="operator">=</span><span class="string">&#x27;xx&#x27;</span>;</span><br><span class="line">replace <span class="keyword">into</span></span><br><span class="line"><span class="keyword">insert</span> ignore </span><br></pre></td></tr></table></figure>
<h4 id="UPDATE">UPDATE</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update tb_user set password = password(&#x27;123456&#x27;),info = &#x27;123&#x27; where user = &#x27;root&#x27;;  --password()密码加密方法</span><br></pre></td></tr></table></figure>
<h4 id="DELETE和TRUNCATE">DELETE和TRUNCATE</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM tb_name WHERE id = 1;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> table_name;  <span class="comment">-- 快速清空表中的所有数据(比DELETE FROM高效)，还能重置自增计数器</span></span><br></pre></td></tr></table></figure>
<h5 id="笔试-5">笔试</h5>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/3d92551a6f6d4f1ebde272d20872cf05?tpId=82&amp;tqId=29810&amp;rp=1&amp;ru=/exam/oj&amp;qru=/exam/oj&amp;sourceUrl=%2Fexam%2Foj%3Fdifficulty%3D5%26page%3D1%26pageSize%3D50%26search%3D%26tab%3DSQL%25E7%25AF%2587%26topicId%3D82&amp;difficulty=undefined&amp;judgeStatus=undefined&amp;tags=&amp;title=%E5%88%A0%E9%99%A4">题目</a>：删除emp_no重复的记录，只保留最小的id对应的记录。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 错误写法：SQL_ERROR_INFO: &quot;You can&#x27;t specify target table &#x27;titles_test&#x27; for update in FROM clause(子句)&quot;</span></span><br><span class="line"><span class="comment">-- 连续两条from同张表</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> titles_test </span><br><span class="line"><span class="keyword">where</span> (id, emp_no) <span class="keyword">not</span> <span class="keyword">in</span> (    </span><br><span class="line">        <span class="keyword">select</span> <span class="built_in">min</span>(id) <span class="keyword">as</span> min_id, emp_no</span><br><span class="line">        <span class="keyword">from</span> titles_test</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> emp_no</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p><strong>mysql不允许在子查询的同时删除原表数据</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正确写法</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> titles_test </span><br><span class="line"><span class="keyword">where</span> (id, emp_no) <span class="keyword">not</span> <span class="keyword">in</span> (    </span><br><span class="line">    <span class="keyword">select</span> min_id, emp_no <span class="keyword">from</span> (</span><br><span class="line">        <span class="keyword">select</span> <span class="built_in">min</span>(id) <span class="keyword">as</span> min_id, emp_no</span><br><span class="line">        <span class="keyword">from</span> titles_test</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> emp_no</span><br><span class="line">    ) <span class="keyword">as</span> t1</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h4 id="index">index</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX index_name ON table_name (column1, column2, ...);</span><br></pre></td></tr></table></figure>
<p>主键索引：id<br>
唯一索引：身份证<br>
普通索引：name<br>
全文索引：大文本<br>
组合索引</p>
<p>where ， join ， &lt;，&lt;=，=，&gt;，&gt;=，BETWEEN，IN，以及某些时候的 LIKE(% 和 _ )</p>
<p>建立一个联合索引 (col1, col2, col3) 等于实际建立了(col1)、(col1,col2)、(col,col2,col3)三个索引。</p>
<p>在检索数据时从联合索引的最左边开始匹配</p>
<h4 id="事务">事务</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">begin;  -- 显示地开启一个事务</span><br><span class="line">start transaction;</span><br><span class="line">commit;  -- 提交事务，并使已对数据库进行的所有修改变为永久性的</span><br><span class="line">rollback;  -- 回滚事务，并撤销正在进行的所有未提交的修改</span><br></pre></td></tr></table></figure>
<h4 id="锁">锁</h4>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">LOCK TABLES person_info_myisam READ;  <span class="comment">-- 读锁，共享锁</span></span><br><span class="line">LOCK TABLES person_info_myisam WRITE;  <span class="comment">-- 写锁，排他锁</span></span><br><span class="line">LOCK TABLES person_info_myisam READ<span class="operator">|</span>WRITE;</span><br><span class="line">UNLOCK TABLES;  <span class="comment">-- 释放锁</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> person_info_large <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">3</span>;  <span class="comment">-- 默认是非阻塞 SELECT</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> person_info_myisam <span class="keyword">WHERE</span> id <span class="keyword">BETWEEN</span> <span class="number">1</span> <span class="keyword">AND</span> <span class="number">1000000</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;  <span class="comment">-- FOR UPDATE上行级排他锁</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> person_info_large <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">3</span> LOCK <span class="keyword">IN</span> SHARE MODE;  <span class="comment">-- LOCK IN SHARE MODE上行级共享读锁</span></span><br></pre></td></tr></table></figure>
<h3 id="4-2DDL">4.2DDL</h3>
<h4 id="建库建表">建库建表</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">create database db_name;</span><br><span class="line"></span><br><span class="line">CREATE TABLE table_name (</span><br><span class="line">    column1 datatype constraint [asc|desc],</span><br><span class="line">    column2 datatype constraint [asc|desc],</span><br><span class="line">    ...</span><br><span class="line">    CONSTRAINT constraint_name</span><br><span class="line">    constraint_type (column1, column2, ...)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">-- 一般在所有的表创建完成后，再用alter table添加约束的方式创建外键，不用考虑创建表的sql顺序</span><br><span class="line">alter table tb_name1</span><br><span class="line">add constraint fk_name1_name2</span><br><span class="line">foreign key(name1id) references tb_name2(name2id) on delete cascade on update cascade;</span><br></pre></td></tr></table></figure>
<h5 id="数据类型">数据类型</h5>
<p>char()：固定长度。会使用空格填充剩余的空间，取数据的时候需要用 trim() 去掉多余的空格。查询效率更高</p>
<p>varchar()：长度可变。动态分配存储空间，更节省空间</p>
<p>nchar()：在 char() 的基础上，支持 Unicode 字符集</p>
<p>nvarchar()：在 varchar() 的基础上，支持 Unicode 字符集</p>
<p>date：‘YYYY-MM-DD’，时间或日期需要用单引号或双引号进行包裹，作为字符串的特殊值解析处理</p>
<p>datetime：‘YYYY-MM-DD HH:MM:SS’，时间或日期需要用单引号或双引号进行包裹，作为字符串的特殊值解析处理</p>
<p>decimal(p, s)：p表示总位数，s表示小数部分的位数。由于浮点数float/double有误差，所以对于需要精确计算的数据(金额)应使用该类型</p>
<p>tinyint(1)，只占1个字节，适合存储存储布尔值、状态标志、开关状态。务必设置长度为1(否则 tkMybatis生成Byte)</p>
<h5 id="约束类型">约束类型</h5>
<p>主键约束：<code>PRIMARY KEY(column1, column2, ...)</code></p>
<p>外键约束：<code>FOREIGN KEY(column1, column2, ...) references tb_name(col_name) on delete cascade on update cascade;</code></p>
<p>唯一约束：<code>UNIQUE</code></p>
<p>非空约束：<code>NOT NULL</code></p>
<p>默认值约束：<code>DEFAULT defaultvalue</code></p>
<p>自动递增约束：<code>AUTO_INCREMENT</code></p>
<h5 id="外键">外键</h5>
<p>并发应用不推荐使用外键：<br>
数据库服务器很容易成为性能瓶颈且不容易轻易地水平扩展，使应用受 IO 能力限制<br>
外键需要额外的维护，更消耗资源，还会因为需要请求其他表而对其他表加锁，容易出现死锁情况。<br>
可以不使用外键级联操作，而使用事务控制数据一致性，让应用服务器承担此部分的压力</p>
<p>外键的级联操作(不推荐使用)：<br>
如果父表中的记录被更新/删除，则子表中对应的记录自动被更新/删除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alter table tb_staff add constraint fk_staff_dep foreign key(did) references department(id) </span><br><span class="line">on delete cascade on update cascade;</span><br></pre></td></tr></table></figure>
<p>外键的级联更新和级联删除：</p>
<ul>
<li>
<p>on update 操作类型：是指在主键表中被参考字段的一条记录的值更新时，进行某种操作</p>
</li>
<li>
<p>on delete 操作类型：是指在主键表中被参考字段的一条记录的值被删除时，进行某种操作</p>
</li>
</ul>
<p>操作类型：</p>
<ul>
<li>no action 表示 不做任何操作，</li>
<li>set null    表示在外键表中将相应字段设置为null</li>
<li>set default 表示设置为默认值</li>
<li>cascade 表示级联操作，就是说，如果主键表中被参考字段更新，外键表中也更新，主键表中的记录被删除，外键表中改行也相应删除</li>
</ul>
<h3 id="4-3其他SQL">4.3其他SQL</h3>
<table>
<thead>
<tr>
<th>其他SQL</th>
<th>释义</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>切换数据库</strong></td>
<td></td>
</tr>
<tr>
<td>show databases;</td>
<td>显示所有数据库的名称</td>
</tr>
<tr>
<td>use 数据库名;</td>
<td>使用数据库</td>
</tr>
<tr>
<td>select database();</td>
<td>显示当前数据库的名称</td>
</tr>
<tr>
<td><strong>权限</strong></td>
<td></td>
</tr>
<tr>
<td>GRANT ALL PRIVILEGES ON <em>.</em> TO root@“%” IDENTIFIED BY “root”;</td>
<td>为root添加远程连接的能力，链接密码为 root</td>
</tr>
<tr>
<td><strong>数据库/表结构</strong></td>
<td></td>
</tr>
<tr>
<td>show create database db_name;</td>
<td>显示指定数据库的名称和创建语句</td>
</tr>
<tr>
<td>show tables;</td>
<td>显示当前所在数据库中的所有表名</td>
</tr>
<tr>
<td>desc tb_name; | SHOW COLUMNS FROM db_name.tb_name;</td>
<td>显示指定表的设计视图</td>
</tr>
<tr>
<td><strong>用户</strong></td>
<td></td>
</tr>
<tr>
<td>select user();</td>
<td>显示当前用户名</td>
</tr>
<tr>
<td><strong>视图</strong></td>
<td></td>
</tr>
<tr>
<td>CREATE VIEW view_s AS SELECT * FROM STU WHERE 性别=‘男’</td>
<td>创建视图</td>
</tr>
</tbody>
</table>
<h2 id="5理论范式">5理论范式</h2>
<p>范式理论：为了规范化关系数据库模式，减少数据冗余和依赖关系，提高数据的一致性和完整性。</p>
<p>1NF：关系表中的每个属性必须是原子的，<strong>不可再分</strong>。</p>
<p>2NF：在满足第一范式的基础上，<strong>非主键属性</strong>不能依赖于主键的部分属性，而只能<strong>依赖于整个主键</strong>。(要求消除部分函数依赖)</p>
<p>3NF：在满足第二范式的基础上，所有非主键属性都<strong>不传递依赖</strong>于候选键</p>
<p>BCNF(推荐)：在满足第二范式的基础上，所有非平凡函数依赖都是候选键的超键，即<strong>非主键属性完全依赖于候选键</strong>。(要求消除所有非平凡函数依赖)</p>
<p>候选键：指能够唯一标识关系表中每个元组的属性组合。一个关系表可以有多个候选键</p>
<p>主键：主键是在候选键中选择的一个，用于确保数据的唯一性和完整性。一个关系表只能有一个主键</p>
<p>函数依赖：描述了属性组合对令一属性组合的决定关系。<br>
A是平凡的函数依赖，A与B的值相同<br>
A是非平凡的函数依赖，B依赖于A，A决定了B的值</p>
<p>有时候我们会有反范式的设计，为了提高数据库查询的性能</p>
<h1>我的</h1>
<h2 id="配置">配置</h2>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/option-files.html">Reference#option-files</a></p>
<p>**Windous 下配置文件：**D:\Develop\mysql\mysql-8.0.32-winx64\my.ini</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MySQL Server Instance Configuration File  # 需要指出的是MySQL5中配置给Mysql8会报错</span></span><br><span class="line"><span class="comment"># 官方文档： https://dev.mysql.com/doc/refman/8.0/en/option-files.html</span></span><br><span class="line"><span class="comment"># ----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># On Linux you can copy this file to /etc/my.cnf to set global options,</span></span><br><span class="line"><span class="comment"># mysql-data-dir/my.cnf to set server-specific options</span></span><br><span class="line"><span class="comment"># (@localstatedir@ for this installation) or to</span></span><br><span class="line"><span class="comment"># ~/.my.cnf to set user-specific options.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># On Windows you should keep this file in the installation directory </span></span><br><span class="line"><span class="comment"># of your server (e.g. C:\Program Files\MySQL\MySQL Server X.Y). To</span></span><br><span class="line"><span class="comment"># make sure the server reads the config file use the startup option </span></span><br><span class="line"><span class="comment"># &quot;--defaults-file&quot;. </span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># To run run the server from the command line, execute this in a </span></span><br><span class="line"><span class="comment"># command line shell, e.g.</span></span><br><span class="line"><span class="comment"># mysqld --defaults-file=&quot;C:\Program Files\MySQL\MySQL Server X.Y\my.ini&quot;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># To install the server as a Windows service manually, execute this in a </span></span><br><span class="line"><span class="comment"># command line shell, e.g.</span></span><br><span class="line"><span class="comment"># mysqld --install MySQLXY --defaults-file=&quot;C:\Program Files\MySQL\MySQL Server X.Y\my.ini&quot;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># And then execute this in a command line shell to start the server, e.g.</span></span><br><span class="line"><span class="comment"># net start MySQLXY</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Guildlines for editing this file</span></span><br><span class="line"><span class="comment"># ----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In this file, you can use all long options that the program supports.</span></span><br><span class="line"><span class="comment"># If you want to know the options a program supports, start the program</span></span><br><span class="line"><span class="comment"># with the &quot;--help&quot; option.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># More detailed information about the individual options can also be</span></span><br><span class="line"><span class="comment"># found in the manual.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># CLIENT SECTION  客户端部分</span></span><br><span class="line"><span class="comment"># ----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The following options will be read by MySQL client applications.</span></span><br><span class="line"><span class="comment"># Note that only client applications shipped by MySQL are guaranteed</span></span><br><span class="line"><span class="comment"># to read this section. If you want your own MySQL client program to</span></span><br><span class="line"><span class="comment"># honor these values, you need to specify it as an option during the</span></span><br><span class="line"><span class="comment"># MySQL client library initialization.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="section">[client]</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3306</span></span><br><span class="line"><span class="attr">default-character-set</span>=utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="comment"># 设置mysql客户端默认字符集。utf8不支持Emoji表情和极少数的汉字</span></span><br><span class="line"><span class="attr">default-character-set</span>=utf8mb4  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># SERVER SECTION  服务端部分</span></span><br><span class="line"><span class="comment"># ----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The following options will be read by the MySQL Server. Make sure that</span></span><br><span class="line"><span class="comment"># you have installed the server correctly (see above) so it reads this </span></span><br><span class="line"><span class="comment"># file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3306</span>  <span class="comment"># The TCP/IP Port the MySQL Server will listen on</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The maximum amount of concurrent sessions the MySQL server will</span></span><br><span class="line"><span class="comment"># allow. One of these connections will be reserved for a user with</span></span><br><span class="line"><span class="comment"># SUPER privileges to allow the administrator to login even if the</span></span><br><span class="line"><span class="comment"># connection limit has been reached.</span></span><br><span class="line"><span class="attr">max_connections</span>=<span class="number">200</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许连接失败的次数。这是为了防止有人从该主机试图攻击数据库系统</span></span><br><span class="line"><span class="attr">max_connect_errors</span>=<span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The default character set that will be used when a new schema or table is</span></span><br><span class="line"><span class="comment"># created and no character set is defined</span></span><br><span class="line"><span class="attr">character-set-server</span>=utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="comment"># The default storage engine that will be used when create new tables when</span></span><br><span class="line"><span class="attr">default-storage-engine</span>=INNODB</span><br><span class="line"></span><br><span class="line"><span class="attr">basedir</span>=<span class="string">&quot;D:/Develop/mysql/mysql-8.0.32-winx64/&quot;</span>  <span class="comment">#Path to installation directory. All paths are usually resolved relative to this.</span></span><br><span class="line"><span class="attr">datadir</span>=<span class="string">&quot;D:/Develop/mysql/mysql-8.0.32-winx64/data/&quot;</span>  <span class="comment">#Path to the database root  数据库存储路径</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置时区</span></span><br><span class="line"><span class="attr">default-time-zone</span>=<span class="string">&#x27;+08:00&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the SQL mode to strict</span></span><br><span class="line"><span class="attr">sql_mode</span>=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION</span><br><span class="line"><span class="comment">#sql-mode=&quot;STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&quot;  # 这个有问题</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自己了解的配置</span></span><br><span class="line"><span class="attr">max_heap_table_size</span> = <span class="number">4000</span>M  <span class="comment"># 限制MEMORY引擎表的大小</span></span><br><span class="line"><span class="attr">log_timestamps</span> = system  <span class="comment"># 设置日志时区</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="安装">安装</h2>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D:\<span class="title">Develop</span>\<span class="title">mysql</span>\<span class="title">mysql</span>-8.0.32-<span class="title">winx64</span>\<span class="title">bin</span>&gt;<span class="title">mysqld</span> --<span class="title">verbose</span> --<span class="title">help</span></span></span><br><span class="line"><span class="function"><span class="title">D</span>:\<span class="title">Develop</span>\<span class="title">mysql</span>\<span class="title">mysql</span>-8.0.32-<span class="title">winx64</span>\<span class="title">bin</span>&gt;<span class="title">mysqld</span> --<span class="title">initialize</span>-<span class="title">insecure</span>  # 创建默认数据库并退出。创建一个密码为空的<span class="title">root</span>用户。在<span class="title">mysql</span>根目录中生产<span class="title">data</span>文件夹</span></span><br><span class="line"><span class="function"><span class="title">D</span>:\<span class="title">Develop</span>\<span class="title">mysql</span>\<span class="title">mysql</span>-8.0.32-<span class="title">winx64</span>\<span class="title">bin</span>&gt;<span class="title">mysqld</span> <span class="title">install</span> <span class="title">MySQL8</span>  # 安装服务</span></span><br><span class="line"><span class="function"><span class="title">Install</span>/<span class="title">Remove</span> <span class="title">of</span> <span class="title">the</span> <span class="title">Service</span> <span class="title">Denied</span>!  # 说明权限不够，需以管理员身份运行</span></span><br><span class="line"><span class="function"><span class="title">D</span>:\<span class="title">Develop</span>\<span class="title">mysql</span>\<span class="title">mysql</span>-8.0.32-<span class="title">winx64</span>\<span class="title">bin</span>&gt;<span class="title">mysql</span> --<span class="title">help</span></span></span><br><span class="line"><span class="function"><span class="title">D</span>:\<span class="title">Develop</span>\<span class="title">mysql</span>\<span class="title">mysql</span>-8.0.32-<span class="title">winx64</span>\<span class="title">bin</span>&gt;<span class="title">mysql</span> -<span class="title">u</span> <span class="title">root</span>  # 登录</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;show databases;</span><br><span class="line">mysql&gt;use mysql;</span><br><span class="line">mysql&gt;show tables;</span><br><span class="line">mysql&gt;select * from user;</span><br><span class="line">mysql&gt;alter user &#x27;root&#x27;@&#x27;localhost&#x27; identified by &#x27;MySQL1616&#x27;;  // 设置root新密码为MySQL1616</span><br><span class="line">mysql&gt;quit</span><br></pre></td></tr></table></figure>
<h2 id="问题">问题</h2>
<p>问题1：远程无法通过root用户3306端口访问MySQL8<br>
原因1：MySQL8默认root用户只能本地localhost访问<br>
原因2：Win防火墙<br>
解决1：修改mysql表中localhost为% where user = root<br>
解决2：Win防火墙添加入站规则，设置3306端口允许连接</p>
<h2 id="CLI">CLI</h2>
<table>
<thead>
<tr>
<th>命令行操作</th>
<th>释义</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>mysqld</strong></td>
<td></td>
</tr>
<tr>
<td>mysqld --initialize -insecure --user=mysql --console</td>
<td>初始化MySQL，需要正确配置my.ini，会创建一个dada文件夹(存所有数据库数据) 在my.ini 中设置的位置，会在控制台打印临时密码<br />-insecure --user 用于指定文件夹的用户权限/拥有者</td>
</tr>
<tr>
<td>mysqld install MySQL8 --defaults-file=“D:/Develop/mysql/mysql-8.0.32-winx64/my.ini”</td>
<td>安装MySQL服务<br />defaults file 要有，用于设置注册表的</td>
</tr>
<tr>
<td>mysqld remove mysql8</td>
<td>卸载 MySQL 服务</td>
</tr>
<tr>
<td><strong>mysqladmin</strong></td>
<td></td>
</tr>
<tr>
<td>mysqladmin -u用户名 -p旧密码 password 新密码</td>
<td>修改密码（在MySQL的bin目录下），不建议采用这种方式(可能是错误的方式)</td>
</tr>
<tr>
<td><strong>mysql</strong></td>
<td></td>
</tr>
<tr>
<td>mysql -h目标主机IP地址 -u用户名 -p [-P端口号]</td>
<td>连接到MySQL，代码通过命令行接口参数输入不安全，所以不在这里输入。第一次登录不需要密码</td>
</tr>
<tr>
<td>mysql –uroot –p123 -Dtest&lt;&quot;C:\test.sql&quot;或source C:\test.sql</td>
<td>执行sql脚本</td>
</tr>
<tr>
<td>exit或quit</td>
<td>退出MySQL</td>
</tr>
<tr>
<td><strong>其他</strong></td>
<td></td>
</tr>
<tr>
<td>net start mysql5</td>
<td>Win管理员权限开启MySQL服务</td>
</tr>
<tr>
<td>net stop mysql8</td>
<td>Win管理员关闭MySQL服务</td>
</tr>
<tr>
<td>sc delete MySQL5</td>
<td>删除服务列表里面的服务</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="MySQL数据库驱动">MySQL数据库驱动</h2>
<h3 id="JDBC驱动程序">JDBC驱动程序</h3>
<p>Java DataBase Connectivity standard Drive</p>
<p>Mysql5.0：com.mysql.jdbc.Driver<br>
Mysql8.0：com.mysql.cj.jdbc.Driver，cj表示connector/J</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- https:<span class="comment">//mvnrepository.com/artifact/com.mysql/mysql-connector-j --&gt;</span></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.mysql&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mysql-connector-j&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">8.3</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># JDBC 连接字符串：</span></span><br><span class="line"><span class="comment"># driveType:databaseType://host:port/database?user=root&amp;password=MySQL1616</span></span><br><span class="line"><span class="attr">jdbc</span>:<span class="string">mysql://localhost:3306/db_name?useUnicode=true&amp;amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line"><span class="comment"># XML中需要使用&amp;amp;代替&amp;，因为&amp;是特殊字符</span></span><br></pre></td></tr></table></figure>
<h2 id="数据库连接池">数据库连接池</h2>
<p>HikariCP</p>
<p>C3P0</p>
<p>Druid</p>
<h2 id="数据库设计">数据库设计</h2>
<h3 id="表间关系一对一">表间关系一对一</h3>
<p>把不经常访问和存在Null值的字段从原表分离，以获得更高的性能</p>
<h3 id="表间关系多对多">表间关系多对多</h3>
<p>通过一个中间表，关联两个一对多关系，就形成了多对多关系</p>
<h1>MariaDB11.3.2</h1>
<p>2009Oracle收购MySQL，MariaDB11.3.2是MySQL的一个分支，CentOS7yum默认MariaDB<br>
<a target="_blank" rel="noopener" href="https://mariadb.org/documentation/">MariaDB官方文档</a>	|	<a target="_blank" rel="noopener" href="https://hub.docker.com/_/mariadb">mariadb-docker容器</a></p>
<h1>未整理</h1>
<h1>业务设计（数据结构）</h1>
<p>数据库设计</p>
<p><strong>电商数据库设计</strong></p>
<p>先写每张表的基本字段，再设计表间关系</p>
<p>不要从表、字段的角度设计，而从实体、模型的角度设计</p>
<h2 id="分类表的常见结构设计">分类表的常见结构设计</h2>
<p>无限级分类：查询效率比较低</p>
<p>四级分类：中小型电商</p>
<p>两级：小项目</p>
<h3 id="记住上级节点">记住上级节点</h3>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for category</span></span><br><span class="line"><span class="comment">-- 数据结构：分类表(category):用二维的关系表来表示的树状结构</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `category`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `category` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `description` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="comment">-- 描述</span></span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>) <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `delete_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `is_root` tinyint(<span class="number">3</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="comment">-- 表示是否是根节点</span></span><br><span class="line">  `parent_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="comment">-- 父节点</span></span><br><span class="line">  `img` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `index` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="comment">-- 尽量多添加一个索引字段，用于运营调整排序</span></span><br><span class="line">  `online` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="comment">-- 表示上架还是下架，即使下架也不会删除而是打上删除表示</span></span><br><span class="line">  `level` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="comment">-- 表示分类的所属级别，可以简化查询请求</span></span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">40</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_general_ci;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="路径表示法">路径表示法</h3>
<p>/node1_id/node2_id/node3_id</p>
<p>添加 path字段，用于保存完整路径，适用于五级分类以上</p>
<p>不太依赖其他记录，每一个节点都可以完整的表达当前的节点信息</p>
<p>缺点：Java代码中需要拼接路径。这是一个<strong>反范式</strong>的设计，有一定程度的冗余，会占用数据库的空间资源</p>
<p>/node1_id#name/node2_id/node3_id</p>
<p>进阶：采用丰富的路径信息 (如，记录name信息。通过自己的定义的方法解析路径)</p>
<h2 id="Theme主题设计">Theme主题设计</h2>
<p>Theme：一组SPU集合</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for theme</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `theme`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `theme` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `title` <span class="type">varchar</span>(<span class="number">60</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `description` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">30</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `tpl_name` <span class="type">varchar</span>(<span class="number">30</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>) <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `delete_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `entrance_img` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `extend` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `internal_top_img` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `title_img` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `online` tinyint(<span class="number">3</span>) unsigned <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">12</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_general_ci;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>title：可以显示到前端的标题</p>
<p>name：是一种文本标识</p>
<p>tpl_name: template_name专题的前端模板（页面模板）的名字</p>
<p>extend：备用的扩展字段</p>
<h3 id="多对多关系表">多对多关系表</h3>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for theme_spu</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `theme_spu`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `theme_spu` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `theme_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `spu_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">101</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_general_ci;</span><br></pre></td></tr></table></figure>
<h3 id="Model设计">Model设计</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.annotations.Where;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/5/7 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Where(clause = &quot;delete_time is null&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Theme</span> <span class="keyword">extends</span> <span class="title class_">BaseEntity</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String tplName;</span><br><span class="line">    <span class="keyword">private</span> String entranceImg;</span><br><span class="line">    <span class="keyword">private</span> String extend;</span><br><span class="line">    <span class="keyword">private</span> String internalTopImg;</span><br><span class="line">    <span class="keyword">private</span> String titleImg;</span><br><span class="line">    <span class="keyword">private</span> Boolean online;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ManyToMany(fetch = FetchType.LAZY)</span></span><br><span class="line">    <span class="meta">@JoinTable(name = &quot;theme_spu&quot;, joinColumns = @JoinColumn(name = &quot;theme_id&quot;),</span></span><br><span class="line"><span class="meta">            inverseJoinColumns = @JoinColumn(name = &quot;spu_id&quot;))</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Spu&gt; spuList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="SPU设计">SPU设计</h2>
<p>SPU：Standard Product Unit （标准化产品单元，是商品信息聚合的最小单位）。例如，iPhone X</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for spu</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- spu: Standard Product Unit 标准化产品单元。 是商品信息聚合的最小单位</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `spu`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `spu` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `title` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `subtitle` <span class="type">varchar</span>(<span class="number">800</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `category_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="comment">--   root_category_id: 为了查询方便，冗余的字段</span></span><br><span class="line">  `root_category_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `online` tinyint(<span class="number">3</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>) <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `delete_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="comment">--   price: spu的价格只是用来展示的，文本类型</span></span><br><span class="line">  `price` <span class="type">varchar</span>(<span class="number">20</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;文本型价格，有时候SPU需要展示的是一个范围，或者自定义平均价格&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  `sketch_spec_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;某种规格可以直接附加单品图片&#x27;</span>,</span><br><span class="line">  `default_sku_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;默认选中的sku&#x27;</span>,</span><br><span class="line">  `img` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `discount_price` <span class="type">varchar</span>(<span class="number">20</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `description` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `tags` <span class="type">varchar</span>(<span class="number">30</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `is_test` tinyint(<span class="number">3</span>) unsigned <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  `spu_theme_img` json <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `for_theme_img` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">29</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_general_ci;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>category_id：表示二级category_id</p>
<p>root_category_id：表示根节点category_id，为了查询方便的冗余字段，不然要一级一级往上查</p>
<p>sketch_spec_id：sketch 略图</p>
<p>price：这价格只是用来展示的，采用文本类型</p>
<p>– 需要计算的价格也不采用浮点类型(存在误差)，一般用decimal类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/4/22 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Spu</span> <span class="keyword">extends</span> <span class="title class_">BaseEntity</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String subtitle;</span><br><span class="line">    <span class="keyword">private</span> Long categoryId;</span><br><span class="line">    <span class="keyword">private</span> Long rootCategoryId;</span><br><span class="line">    <span class="keyword">private</span> Boolean online;</span><br><span class="line">    <span class="keyword">private</span> String price;</span><br><span class="line">    <span class="keyword">private</span> Long sketchSpecId;</span><br><span class="line">    <span class="keyword">private</span> Long defaultSkuId;</span><br><span class="line">    <span class="keyword">private</span> String img;</span><br><span class="line">    <span class="keyword">private</span> String discountPrice;</span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">    <span class="keyword">private</span> String tags;</span><br><span class="line">    <span class="keyword">private</span> Boolean isTest;</span><br><span class="line"><span class="comment">//    private Object spuThemeImg;</span></span><br><span class="line">    <span class="keyword">private</span> String forThemeImg;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OneToMany(fetch = FetchType.LAZY)</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;spuId&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Sku&gt; skuList;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OneToMany(fetch = FetchType.LAZY)</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;spuId&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SpuImg&gt; spuImgList;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OneToMany(fetch = FetchType.LAZY)</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;spuId&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SpuDetailImg&gt; spuDetailImgList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="spu-detail-img">spu_detail_img</h3>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for spu_detail_img</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `spu_detail_img`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `spu_detail_img` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `img` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `spu_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `index` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>) <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `delete_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">28</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_general_ci;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Id;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/4/22 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpuDetailImg</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String img;</span><br><span class="line">    <span class="keyword">private</span> Long spuId;</span><br><span class="line">    <span class="keyword">private</span> Long index;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="spu-img">spu_img</h3>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for spu_img</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `spu_img`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `spu_img` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `img` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `spu_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `delete_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>) <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">194</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_general_ci;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Id;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/4/22 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpuImg</span> <span class="keyword">extends</span> <span class="title class_">BaseEntity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String img;</span><br><span class="line">    <span class="keyword">private</span> Long spuId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="SKU设计">SKU设计</h2>
<p>SKU：Stock Keeping Unit（库存量单位）。例如，iPhone X,64g,银色 是一个SKU</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for sku</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `sku`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `sku` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `price` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `discount_price` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) unsigned <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `online` tinyint(<span class="number">3</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">  `img` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `title` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `spu_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>) <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `delete_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `specs` json <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `code` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `stock` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  `category_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `root_category_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">52</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_general_ci;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>SPU里category_id、root_category_id是冗余的，因为可根据SKU找SPU再找Category，是因为不想做级联的查询</p>
<p>specs：JSON表示和规格有关的复杂数据结构，冗余字段，用于减少查询次数</p>
<p>这里的specs表示商品的规格，是可以商家自定义的，因此如果设计为一个表则没有能增加字段的方式，所以设计为一个Json字段表示一个对象，需要时再反序列化为对象使用</p>
<blockquote>
<p>序列化</p>
<p>解决对象对象的传输（把对象序列化为通用的字符串写入到一个字段中）和存储（可以使用MongoDB，文档型数据库）的问题<br>
前端是可以将字符串组合成JSON对象的</p>
<p>序列化有 Jackson和FastJson等库</p>
</blockquote>
<p>code：如15$1-19#6-28，15是SPU的id，1-19表示颜色，6-28表示尺码，是自定义的字符串，表示每个SKU的唯一的标识，和id类似，但是code具有可解析性，便于前端处理</p>
<p>stock：表示库存量（如何业务需要不同单位，可以添加一个单位的表）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Id;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/4/22 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sku</span> <span class="keyword">extends</span> <span class="title class_">BaseEntity</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal discountPrice;</span><br><span class="line">    <span class="keyword">private</span> Boolean online;</span><br><span class="line">    <span class="keyword">private</span> String img;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> Long spuId;</span><br><span class="line">    <span class="keyword">private</span> Long categoryId;</span><br><span class="line">    <span class="keyword">private</span> Long rootCategoryId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String specs;</span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line">    <span class="keyword">private</span> Long stock;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="规格Spec">规格Spec</h3>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for sku_spec</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `sku_spec`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `sku_spec` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `spu_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `sku_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `key_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `value_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">90</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_general_ci;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>规格Spec和库存量单位SKU的多对多关系，SKU_Spec表是多对多关系的第三张表</p>
<p>spu_id、key_id 是冗余字段</p>
<h3 id="SPU-SKU-Spec关系">SPU-SKU-Spec关系</h3>
<p>Spu - Spec_Key 多对多</p>
<p>Sku - Spec_Value 多对多</p>
<p>Spu - Sku 一对多</p>
<h3 id="规格名Spec-Kye">规格名Spec_Kye</h3>
<p>如颜色、尺码</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for spec_key</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `spec_key`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `spec_key` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `unit` <span class="type">varchar</span>(<span class="number">30</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `standard` tinyint(<span class="number">3</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  `delete_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `description` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">9</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_general_ci;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="规格值Spec-Value">规格值Spec_Value</h3>
<p>如橙色、蓝色；XL、L、M、S</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for spec_value</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `spec_value`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `spec_value` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `<span class="keyword">value</span>` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `spec_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>) <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `delete_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `extend` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">46</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_general_ci;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Banner">Banner</h2>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for banner</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `banner`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `banner` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `description` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>) <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `delete_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `title` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `img` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;部分banner可能有标题图片&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">3</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_general_ci;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/2/8 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Banner</span> <span class="keyword">extends</span> <span class="title class_">BaseEntity</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String img;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OneToMany(fetch = FetchType.LAZY)</span></span><br><span class="line">    <span class="meta">@JoinColumn(name=&quot;bannerId&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;BannerItem&gt; items;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Banner-Item">Banner_Item</h3>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for banner_item</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `banner_item`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `banner_item` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `img` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `keyword` <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `type` <span class="type">smallint</span>(<span class="number">5</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>) <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `delete_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `banner_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">16</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_general_ci;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Id;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/2/8 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BannerItem</span> <span class="keyword">extends</span> <span class="title class_">BaseEntity</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String img;</span><br><span class="line">    <span class="keyword">private</span> String keyword;</span><br><span class="line">    <span class="keyword">private</span> Short type;</span><br><span class="line">    <span class="keyword">private</span> Long bannerId;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Category">Category</h2>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for category</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `category`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `category` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `description` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>) <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `delete_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `is_root` tinyint(<span class="number">3</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  `parent_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `img` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `index` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `online` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">  `level` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">40</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_general_ci;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>grid_category：宫格分类，表示需要特别显示的分类</p>
<h2 id="Coupon-优惠卷">Coupon 优惠卷</h2>
<p>加入优惠卷后小麻烦，需要管理优惠卷还需要校验</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">--  Table structure for `coupon`</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `coupon`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `coupon` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `title` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `start_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `end_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `description` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `full_money` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `minus` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `rate` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> ,</span><br><span class="line">  `type` <span class="type">smallint</span>(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;1. 满减券 2.折扣券 3.无门槛券 4.满金额折扣券&#x27;</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>) <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `delete_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `activity_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `remark` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `whole_store` tinyint(<span class="number">3</span>) unsigned <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">12</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_general_ci;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="user-coupon-用户有的优惠卷">user_coupon 用户有的优惠卷</h2>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for user_coupon</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `user_coupon`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_coupon` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `user_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `coupon_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `status` tinyint(<span class="number">3</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;1:未使用，2：已使用， 3：已过期&#x27;</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `order_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>) <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uni_user_coupon` (`user_id`,`coupon_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">31</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_general_ci;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>status不能完全表示优惠卷的状态，因为要引入Redis和消息队列，那么是异步的，需要考虑线程安全。</p>
<p>优惠卷过期问题 status:未使用、已使用、已过期：触发机制<br>
1.主动触发：轮询机制（隔多久扫描一次数据库）<br>
2.被动触发：设置第三方在过期时间点发消息<br>
Redis / RocketMQ</p>
<p>在判断是否过期时，尽量不能使用 状态字段(status) ，而是使用 startTime、endTime</p>
<p>计算折扣时，使用银行家算法</p>
<h3 id="优惠卷过期状态问题">优惠卷过期状态问题</h3>
<p>通过复杂查询，间接查询优惠卷的状态</p>
<h2 id="Order-订单">Order 订单</h2>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for order</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `<span class="keyword">order</span>`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">order</span>` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">	<span class="comment">-- 表间自增id可能不唯一</span></span><br><span class="line">  `order_no` <span class="type">varchar</span>(<span class="number">20</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="comment">-- 唯一订单编号，方便分布式的分库分表</span></span><br><span class="line">  `user_id` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;user表外键&#x27;</span>,</span><br><span class="line">  `total_price` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0.00&#x27;</span>,</span><br><span class="line">    <span class="comment">-- 原始价格</span></span><br><span class="line">  `total_count` <span class="type">int</span>(<span class="number">11</span>) unsigned <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `delete_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `expired_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `placed_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>) <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  `snap_img` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `snap_title` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `snap_items` json <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `snap_address` json <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="comment">-- 快照，不记录实时信息</span></span><br><span class="line">  `prepay_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="comment">-- 用于支付的id</span></span><br><span class="line">  `final_total_price` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `status` tinyint(<span class="number">3</span>) unsigned <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uni_order_no` (`order_no`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">272</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_general_ci;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>订单的校验参数：<br>
1.商品是否有货<br>
2.商品最大购买数量<br>
3.SKU是否存在<br>
4.totalPrice<br>
5.finalTotalPrice<br>
6.是否拥有优惠卷<br>
7.优惠卷是否过期</p>
<h3 id="前端传过来的订单数据">前端传过来的订单数据</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.DecimalMax;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.DecimalMin;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 前端价格不可信</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/5/9 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderDTO</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DecimalMin(value = &quot;0.00&quot;, message = &quot;不在合法范围内&quot;)</span></span><br><span class="line">    <span class="meta">@DecimalMax(value = &quot;99999999,99&quot;, message = &quot;不在合法范围内&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal totalPrice;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal finalTotalPrice;</span><br><span class="line">    <span class="keyword">private</span> Long couponId;</span><br><span class="line">    <span class="keyword">private</span> List&lt;SkuInfoDTO&gt; skuInfoList;</span><br><span class="line">    <span class="keyword">private</span> OrderAddressDTO address;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="在service中处理的订单业务对象BO">在service中处理的订单业务对象BO</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.bo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.zjbti.missyou.dto.SkuInfoDTO;</span><br><span class="line"><span class="keyword">import</span> com.zjbti.missyou.model.Sku;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/5/10 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SkuOrderBO</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BigDecimal actualPrice;  <span class="comment">// 真实价格</span></span><br><span class="line">    <span class="keyword">private</span> Integer count;</span><br><span class="line">    <span class="keyword">private</span> Long categoryId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SkuOrderBO</span><span class="params">(Sku sku, SkuInfoDTO skuInfoDTO)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.actualPrice = sku.getActualPrice();</span><br><span class="line">        <span class="built_in">this</span>.count = skuInfoDTO.getCount();</span><br><span class="line">        <span class="built_in">this</span>.categoryId = sku.getCategoryId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">getTotalPrice</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.actualPrice.multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="built_in">this</span>.count));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="订单自动取消机制">订单自动取消机制</h3>
<p>消息队列，Redis 实现</p>
<p>两种方式</p>
<p>不记录 expired_time，在更该支付延长时间会有问题</p>
<p>Order（根据库存，下订单）和Coupon（根据优惠卷分类查询）不一样，需要明确的状态</p>
<p>Order 还需要 （自动取消订单，归还库存）<br>
怎么归还库存、什么时候、谁来触发归还库存</p>
<p>怎么归还？</p>
<p>​	1主动轮询，定时器，Java Timer，Linux Corntab，定时任务框架 Quartz</p>
<p>​	2被动触发，用户触发，过期时间 类似用户/角色</p>
<p>​	3队列，先进先出，RocketMQ，RabbitMQ，Kafka  系统 取，队列主动返回</p>
<p>​	4延迟消息队列 Redis 键名通知、RocketMQ(比Redis可靠)</p>
<p>触发时机？</p>
<p>​	redis的键空间通知(在某个键控件发生了指定类型的操作比如expire过期操作，那么订阅了该键控件的客户端都会收到通知)</p>
<p>当然也可以使用RocketMQ 作为延迟消息队列，都是可以d</p>
<h3 id="库存扣除机制">库存扣除机制</h3>
<p>在支付时扣除库存，容易因并发，出现超卖的情况</p>
<p>多线程并发要有乱序思维</p>
<p>情况：<br>
1.正常<br>
2.负数<br>
3.报错（库存不足）<br>
4.加锁 排队<br>
数据库行锁 悲观锁  性能不高   （开启事务 select … sku.tock for update）,不推荐，因为并发消耗大，如果索引不正确容易锁表<br>
数据库 锁 <strong>乐观锁</strong>乐观并发机制	没有实际锁  并发/竞态 思想<br>
<code>update sku set stock = newValue version = version + 1 where version = 查出来的version</code>用version保证不重复</p>
<p>​		Java加锁（分布式无效）</p>
<p>错误思维：先查询再判断再执行业务逻辑，线程不安全，两条SQL不是一个原子的操作<br>
事务也不能解决，事务不等于锁</p>
<h4 id="预扣除库存机制">预扣除库存机制</h4>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.haruharu.top">Nemesis</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.haruharu.top/articles/Dev/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL8/">https://blog.haruharu.top/articles/Dev/数据库/MySQL8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.haruharu.top" target="_blank">Nemesis</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/articles/Dev/Network/Network/" title="计算机网络"><img class="cover" src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_05_01_15_19.gif" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">计算机网络</div></div></a></div><div class="next-post pull-right"><a href="/articles/Dev/language/Java/java-library/%E6%97%A5%E5%BF%97/" title="日志框架"><img class="cover" src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting2/img/2024_0314_003300.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">日志框架</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Nemesis</div><div class="author-info__description">浙江外国语学院大四老人</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">69</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">34</div></a></div><a id="card-info-btn" href="mailto:chenxiangcheng1@gmail.com"><i class="fas fa-envelope"></i><span>Contact Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/chenxiangcheng1" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:chenxiangcheng1@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://space.bilibili.com/36033539" target="_blank" title="Bili"><i class="fa-brands fa-bilibili" style="color: #74C0FC;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">有空B站直播写代码 ( •̀ ω •́ )✧</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">MySQL8</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E6%A1%A3"><span class="toc-number">1.1.</span> <span class="toc-text">文档</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">1 关系型数据库管理系统架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E7%B4%A2%E5%BC%95%E6%A8%A1%E5%9D%97"><span class="toc-number">1.3.</span> <span class="toc-text">2索引模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1索引的作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E7%B4%A2%E5%BC%95%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.2索引类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%E7%B4%A2%E5%BC%95%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.3.</span> <span class="toc-text">2.3索引的数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%B3%E8%A1%A1%E4%BA%8C%E5%8F%89%E6%A0%91%E6%88%96%E7%BA%A2%E9%BB%91%E6%A0%91"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">平衡二叉树或红黑树</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#B-Tree"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">B-Tree</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#B-Tree%E7%B4%A2%E5%BC%95"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">B+Tree索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Hash%E7%B4%A2%E5%BC%95"><span class="toc-number">1.3.3.4.</span> <span class="toc-text">Hash索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BitMap%E4%BD%8D%E5%9B%BE%E7%B4%A2%E5%BC%95"><span class="toc-number">1.3.3.5.</span> <span class="toc-text">BitMap位图索引</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4%E5%AF%86%E9%9B%86%E7%B4%A2%E5%BC%95%E5%92%8C%E7%A8%80%E7%96%8F%E7%B4%A2%E5%BC%95"><span class="toc-number">1.3.4.</span> <span class="toc-text">2.4密集索引和稀疏索引</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#InnoDB-%E7%9A%84%E8%81%9A%E9%9B%86%E7%B4%A2%E5%BC%95%E9%80%89%E5%8F%96%E8%A7%84%E5%88%99%EF%BC%9A"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">InnoDB 的聚集索引选取规则：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5%E5%AE%9A%E4%BD%8D%E5%B9%B6%E4%BC%98%E5%8C%96%E6%85%A2%E6%9F%A5%E8%AF%A2SQL"><span class="toc-number">1.3.5.</span> <span class="toc-text">2.5定位并优化慢查询SQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6%E7%BB%84%E5%90%88%E7%B4%A2%E5%BC%95%E7%9A%84%E6%9C%80%E5%B7%A6%E5%89%8D%E7%BC%80%E5%8C%B9%E9%85%8D%E5%8E%9F%E5%88%99"><span class="toc-number">1.3.6.</span> <span class="toc-text">2.6组合索引的最左前缀匹配原则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E9%94%81%E6%A8%A1%E5%9D%97"><span class="toc-number">1.4.</span> <span class="toc-text">3锁模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1MyISAM%E4%B8%8EInnoDB%E5%85%B3%E4%BA%8E%E9%94%81%E6%96%B9%E9%9D%A2%E7%9A%84%E5%8C%BA%E5%88%AB%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.4.1.</span> <span class="toc-text">3.1MyISAM与InnoDB关于锁方面的区别是什么</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MyISAM"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">MyISAM</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A1%A8%E7%BA%A7%E9%94%81"><span class="toc-number">1.4.1.1.1.</span> <span class="toc-text">表级锁</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MyISAM-%E9%80%82%E5%90%88%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="toc-number">1.4.1.1.2.</span> <span class="toc-text">MyISAM 适合的场景</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#InnoDB"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">InnoDB</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%84%8F%E5%90%91%E9%94%81"><span class="toc-number">1.4.1.2.1.</span> <span class="toc-text">意向锁</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#InnoDB%E9%80%82%E5%90%88%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="toc-number">1.4.1.2.2.</span> <span class="toc-text">InnoDB适合的场景</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%81%E7%9A%84%E5%88%86%E7%B1%BB"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">锁的分类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%89%E9%94%81%E7%9A%84%E7%B2%92%E5%BA%A6%E5%88%92%E5%88%86"><span class="toc-number">1.4.1.3.1.</span> <span class="toc-text">按锁的粒度划分</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%89%E9%94%81%E7%9A%84%E7%BA%A7%E5%88%AB%E5%88%92%E5%88%86"><span class="toc-number">1.4.1.3.2.</span> <span class="toc-text">按锁的级别划分</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%89%E9%94%81%E7%9A%84%E8%8E%B7%E5%8F%96%E6%96%B9%E5%BC%8F%E5%88%92%E5%88%86"><span class="toc-number">1.4.1.3.3.</span> <span class="toc-text">按锁的获取方式划分</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%89%E9%94%81%E7%9A%84%E7%94%A8%E9%80%94%E5%88%92%E5%88%86"><span class="toc-number">1.4.1.3.4.</span> <span class="toc-text">按锁的用途划分</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%89%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E7%AD%96%E7%95%A5%E5%88%92%E5%88%86-%E9%BB%98%E8%AE%A4"><span class="toc-number">1.4.1.3.5.</span> <span class="toc-text">按并发控制策略划分(默认)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B9%90%E8%A7%82%E9%94%81"><span class="toc-number">1.4.1.3.5.1.</span> <span class="toc-text">乐观锁</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%82%B2%E8%A7%82%E9%94%81"><span class="toc-number">1.4.1.3.5.2.</span> <span class="toc-text">悲观锁</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%9B%9B%E5%A4%A7%E7%89%B9%E6%80%A7-ACID"><span class="toc-number">1.4.2.</span> <span class="toc-text">3.2事务的四大特性 ACID</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E8%AE%BF%E9%97%AE%E9%97%AE%E9%A2%98"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">并发访问问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB-%E9%9A%94%E7%A6%BB%E6%80%A7%E7%9A%84%E5%85%B7%E4%BD%93%E4%BD%93%E7%8E%B0"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">事务隔离级别(隔离性的具体体现)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3%E5%BD%93%E5%89%8D%E8%AF%BB%E5%92%8C%E5%BF%AB%E7%85%A7%E8%AF%BB"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">3.3当前读和快照读</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4Undo%E6%92%A4%E9%94%80%E6%97%A5%E5%BF%97-Read-View-%E5%AE%9E%E7%8E%B0%E5%BF%AB%E7%85%A7%E8%AF%BB"><span class="toc-number">1.4.2.3.1.</span> <span class="toc-text">3.4Undo撤销日志 + Read View 实现快照读</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-5%E5%BD%93%E5%89%8D%E8%AF%BB%E7%9A%84next-key%E9%94%81"><span class="toc-number">1.4.2.3.2.</span> <span class="toc-text">3.5当前读的next-key锁</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E8%AF%AD%E6%B3%95SQL"><span class="toc-number">1.5.</span> <span class="toc-text">4语法SQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8F%E5%92%8C%E7%8A%B6%E6%80%81%E5%8F%98%E9%87%8F"><span class="toc-number">1.5.1.</span> <span class="toc-text">系统变量和状态变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1DML"><span class="toc-number">1.5.2.</span> <span class="toc-text">4.1DML</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E9%87%8A"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">注释</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SELECT"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">SELECT</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.5.2.2.1.</span> <span class="toc-text">关联查询</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%94%E8%AF%95"><span class="toc-number">1.5.2.2.1.1.</span> <span class="toc-text">笔试</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#group-by-%E5%92%8C-having-%E5%92%8C%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0"><span class="toc-number">1.5.2.2.2.</span> <span class="toc-text">group by 和 having 和聚合函数</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%94%E8%AF%95-2"><span class="toc-number">1.5.2.2.2.1.</span> <span class="toc-text">笔试</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%94%E8%AF%95-3"><span class="toc-number">1.5.2.2.3.</span> <span class="toc-text">笔试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E5%85%B3%E9%94%AE%E5%AD%97"><span class="toc-number">1.5.2.2.4.</span> <span class="toc-text">相关关键字</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0"><span class="toc-number">1.5.2.2.5.</span> <span class="toc-text">窗口函数</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#INSERT"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">INSERT</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%94%E8%AF%95-4"><span class="toc-number">1.5.2.3.1.</span> <span class="toc-text">笔试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UPDATE"><span class="toc-number">1.5.2.4.</span> <span class="toc-text">UPDATE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DELETE%E5%92%8CTRUNCATE"><span class="toc-number">1.5.2.5.</span> <span class="toc-text">DELETE和TRUNCATE</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%94%E8%AF%95-5"><span class="toc-number">1.5.2.5.1.</span> <span class="toc-text">笔试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#index"><span class="toc-number">1.5.2.6.</span> <span class="toc-text">index</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.5.2.7.</span> <span class="toc-text">事务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%81"><span class="toc-number">1.5.2.8.</span> <span class="toc-text">锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2DDL"><span class="toc-number">1.5.3.</span> <span class="toc-text">4.2DDL</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%BA%E5%BA%93%E5%BB%BA%E8%A1%A8"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">建库建表</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.5.3.1.1.</span> <span class="toc-text">数据类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BA%A6%E6%9D%9F%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.5.3.1.2.</span> <span class="toc-text">约束类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%96%E9%94%AE"><span class="toc-number">1.5.3.1.3.</span> <span class="toc-text">外键</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3%E5%85%B6%E4%BB%96SQL"><span class="toc-number">1.5.4.</span> <span class="toc-text">4.3其他SQL</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E7%90%86%E8%AE%BA%E8%8C%83%E5%BC%8F"><span class="toc-number">1.6.</span> <span class="toc-text">5理论范式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">我的</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">2.2.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">2.3.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CLI"><span class="toc-number">2.4.</span> <span class="toc-text">CLI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E9%A9%B1%E5%8A%A8"><span class="toc-number">2.5.</span> <span class="toc-text">MySQL数据库驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JDBC%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.5.1.</span> <span class="toc-text">JDBC驱动程序</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-number">2.6.</span> <span class="toc-text">数据库连接池</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.7.</span> <span class="toc-text">数据库设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E9%97%B4%E5%85%B3%E7%B3%BB%E4%B8%80%E5%AF%B9%E4%B8%80"><span class="toc-number">2.7.1.</span> <span class="toc-text">表间关系一对一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E9%97%B4%E5%85%B3%E7%B3%BB%E5%A4%9A%E5%AF%B9%E5%A4%9A"><span class="toc-number">2.7.2.</span> <span class="toc-text">表间关系多对多</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">MariaDB11.3.2</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">未整理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">业务设计（数据结构）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E7%B1%BB%E8%A1%A8%E7%9A%84%E5%B8%B8%E8%A7%81%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.1.</span> <span class="toc-text">分类表的常见结构设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%B0%E4%BD%8F%E4%B8%8A%E7%BA%A7%E8%8A%82%E7%82%B9"><span class="toc-number">5.1.1.</span> <span class="toc-text">记住上级节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E5%BE%84%E8%A1%A8%E7%A4%BA%E6%B3%95"><span class="toc-number">5.1.2.</span> <span class="toc-text">路径表示法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Theme%E4%B8%BB%E9%A2%98%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.2.</span> <span class="toc-text">Theme主题设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A%E5%85%B3%E7%B3%BB%E8%A1%A8"><span class="toc-number">5.2.1.</span> <span class="toc-text">多对多关系表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Model%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.2.2.</span> <span class="toc-text">Model设计</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SPU%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.3.</span> <span class="toc-text">SPU设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#spu-detail-img"><span class="toc-number">5.3.1.</span> <span class="toc-text">spu_detail_img</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#spu-img"><span class="toc-number">5.3.2.</span> <span class="toc-text">spu_img</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SKU%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.4.</span> <span class="toc-text">SKU设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%84%E6%A0%BCSpec"><span class="toc-number">5.4.1.</span> <span class="toc-text">规格Spec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SPU-SKU-Spec%E5%85%B3%E7%B3%BB"><span class="toc-number">5.4.2.</span> <span class="toc-text">SPU-SKU-Spec关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%84%E6%A0%BC%E5%90%8DSpec-Kye"><span class="toc-number">5.4.3.</span> <span class="toc-text">规格名Spec_Kye</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%84%E6%A0%BC%E5%80%BCSpec-Value"><span class="toc-number">5.4.4.</span> <span class="toc-text">规格值Spec_Value</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Banner"><span class="toc-number">5.5.</span> <span class="toc-text">Banner</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Banner-Item"><span class="toc-number">5.5.1.</span> <span class="toc-text">Banner_Item</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Category"><span class="toc-number">5.6.</span> <span class="toc-text">Category</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Coupon-%E4%BC%98%E6%83%A0%E5%8D%B7"><span class="toc-number">5.7.</span> <span class="toc-text">Coupon 优惠卷</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#user-coupon-%E7%94%A8%E6%88%B7%E6%9C%89%E7%9A%84%E4%BC%98%E6%83%A0%E5%8D%B7"><span class="toc-number">5.8.</span> <span class="toc-text">user_coupon 用户有的优惠卷</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E6%83%A0%E5%8D%B7%E8%BF%87%E6%9C%9F%E7%8A%B6%E6%80%81%E9%97%AE%E9%A2%98"><span class="toc-number">5.8.1.</span> <span class="toc-text">优惠卷过期状态问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Order-%E8%AE%A2%E5%8D%95"><span class="toc-number">5.9.</span> <span class="toc-text">Order 订单</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E4%BC%A0%E8%BF%87%E6%9D%A5%E7%9A%84%E8%AE%A2%E5%8D%95%E6%95%B0%E6%8D%AE"><span class="toc-number">5.9.1.</span> <span class="toc-text">前端传过来的订单数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8service%E4%B8%AD%E5%A4%84%E7%90%86%E7%9A%84%E8%AE%A2%E5%8D%95%E4%B8%9A%E5%8A%A1%E5%AF%B9%E8%B1%A1BO"><span class="toc-number">5.9.2.</span> <span class="toc-text">在service中处理的订单业务对象BO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95%E8%87%AA%E5%8A%A8%E5%8F%96%E6%B6%88%E6%9C%BA%E5%88%B6"><span class="toc-number">5.9.3.</span> <span class="toc-text">订单自动取消机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%93%E5%AD%98%E6%89%A3%E9%99%A4%E6%9C%BA%E5%88%B6"><span class="toc-number">5.9.4.</span> <span class="toc-text">库存扣除机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%84%E6%89%A3%E9%99%A4%E5%BA%93%E5%AD%98%E6%9C%BA%E5%88%B6"><span class="toc-number">5.9.4.1.</span> <span class="toc-text">预扣除库存机制</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/%E4%BA%8C%E7%BA%A7%E5%B8%82%E5%9C%BA/%E8%80%83%E8%AF%95/%E5%9F%BA%E4%BB%8E/" title="基金从业资格证">基金从业资格证</a><time datetime="2024-06-01T16:00:00.000Z" title="发表于 2024-06-02 00:00:00">2024-06-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/Dev/language/small-language/YAML1.2/" title="YAML">YAML</a><time datetime="2024-04-19T16:00:00.000Z" title="发表于 2024-04-20 00:00:00">2024-04-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/articles/Dev/%E6%9C%8D%E5%8A%A1%E4%B8%AD%E9%97%B4%E4%BB%B6/Web%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/" title="Nginx"><img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting2/img/2023_09_25_08_26_56.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nginx"/></a><div class="content"><a class="title" href="/articles/Dev/%E6%9C%8D%E5%8A%A1%E4%B8%AD%E9%97%B4%E4%BB%B6/Web%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/" title="Nginx">Nginx</a><time datetime="2024-03-17T16:00:00.000Z" title="发表于 2024-03-18 00:00:00">2024-03-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/articles/Dev/design-patterns/%E7%BB%93%E6%9E%84%E5%9E%8B/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F/" title="桥接模式"><img src="https://refactoringguru.cn/images/patterns/diagrams/bridge/structure-zh.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="桥接模式"/></a><div class="content"><a class="title" href="/articles/Dev/design-patterns/%E7%BB%93%E6%9E%84%E5%9E%8B/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F/" title="桥接模式">桥接模式</a><time datetime="2024-03-12T16:00:00.000Z" title="发表于 2024-03-13 00:00:00">2024-03-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/articles/Dev/design-patterns/%E5%88%9B%E5%BB%BA%E5%9E%8B/%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/" title="抽象工厂模式"><img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting2/img/2024_0308_133937.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="抽象工厂模式"/></a><div class="content"><a class="title" href="/articles/Dev/design-patterns/%E5%88%9B%E5%BB%BA%E5%9E%8B/%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/" title="抽象工厂模式">抽象工厂模式</a><time datetime="2024-03-07T16:00:00.000Z" title="发表于 2024-03-08 00:00:00">2024-03-08</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting1/img/2023_03_28_14_30.png')"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By Nemesis</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="/js/tw_cn.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(()=>{
  const getGiscusTheme = theme => {
    return theme === 'dark' ? 'dark' : 'light'
  }

  const loadGiscus = () => {
    const config = Object.assign({
      src: 'https://giscus.app/client.js',
      'data-repo': 'ChenXiangcheng1/chenxiangcheng1.github.io',
      'data-repo-id': 'R_kgDOJEy5Dw',
      'data-category-id': 'DIC_kwDOJEy5D84CfyxF',
      'data-mapping': 'pathname',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true
    },{"data-mapping":"title","data-input-position":"bottom"})

    const ele = document.createElement('script')
    for (let key in config) {
      ele.setAttribute(key, config[key])
    }
    document.getElementById('giscus-wrap').appendChild(ele)
  }

  const changeGiscusTheme = theme => {
    const sendMessage = message => {
      const iframe = document.querySelector('iframe.giscus-frame')
      if (!iframe) return
      iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app')
    }

    sendMessage({
      setConfig: {
        theme: getGiscusTheme(theme)
      }
    });
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if ('Giscus' === 'Giscus' || !true) {
    if (true) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment= loadGiscus
  }
})()</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script async data-pjax src="https://cdn.jsdelivr.net/gh/Pil0tXia/busuanzi-modified/busuanzi.pure.mini.js"></script></div></body></html>