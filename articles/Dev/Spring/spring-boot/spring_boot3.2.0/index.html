<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Spring Boot | Nemesis</title><meta name="author" content="Nemesis,chenxiangcheng1@gmail.com"><meta name="copyright" content="Nemesis"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="主要关于Spring Boot的启动流程和自动配置原理">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Boot">
<meta property="og:url" content="https://blog.haruharu.top/articles/Dev/Spring/spring-boot/spring_boot3.2.0/">
<meta property="og:site_name" content="Nemesis">
<meta property="og:description" content="主要关于Spring Boot的启动流程和自动配置原理">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.haruharu.top/img/avatar.png">
<meta property="article:published_time" content="2023-08-23T16:00:00.000Z">
<meta property="article:modified_time" content="2024-03-18T03:17:08.544Z">
<meta property="article:author" content="Nemesis">
<meta property="article:tag" content="博客,ACM,技术,开发">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.haruharu.top/img/avatar.png"><link rel="shortcut icon" href="/img/favicon48.ico"><link rel="canonical" href="https://blog.haruharu.top/articles/Dev/Spring/spring-boot/spring_boot3.2.0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":200,"languages":{"author":"作者: Nemesis","link":"链接: ","source":"来源: Nemesis","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Spring Boot',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-03-18 11:17:08'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 23
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">69</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">34</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/default_top_img.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Nemesis"><span class="site-name">Nemesis</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Spring Boot</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-08-23T16:00:00.000Z" title="发表于 2023-08-24 00:00:00">2023-08-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-03-18T03:17:08.544Z" title="更新于 2024-03-18 11:17:08">2024-03-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Spring/">Spring</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Spring/Spring-Boot/">Spring Boot</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>35分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Spring Boot"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>Spring Boot</h1>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/">Reference文档</a>	|	<a target="_blank" rel="noopener" href="https://springdoc.cn/spring-boot/index.html">参考文档(中文)</a>	|	[API 文档][<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/api/">https://docs.spring.io/spring-boot/docs/current/api/</a>]	|	<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-boot">源码</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Modules</span><br><span class="line">├──spring-boot							<span class="comment"># 提供了核心特性的支持</span></span><br><span class="line">├──spring-boot-autoconfigure</span><br><span class="line">|		└──@EnableAutoConfiguration  	<span class="comment"># 注释会Spring上下文的自动装配</span></span><br><span class="line">├──spring-boot-starters  				<span class="comment"># 依赖描述符</span></span><br><span class="line">├──spring-boot-actuator</span><br><span class="line">├──spring-boot-actuator-autoconfigure</span><br><span class="line">├──spring-boot-test</span><br><span class="line">├──spring-boot-test-autoconfigure</span><br><span class="line">├──spring-boot-loader</span><br><span class="line">└──spring-boot-devtools  				<span class="comment"># 提供了额外的开发时功能</span></span><br></pre></td></tr></table></figure>
<h2 id="版本">版本</h2>
<p>Spring Boot 3.0，Spring Boot 2.7~2.4 和 2.4 以下版本之间变化较大</p>
<p><a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-boot/wiki#release-notes">github spring boot wiki#release-notes</a></p>
<h2 id="Spring-Boot-核心特性">Spring Boot 核心特性</h2>
<ul>
<li>可独立运行的应用程序<br>
uber jar(超级jar包)：是将应用程序的所有依赖项打包到一个独立的 JAR 文件中，使得应用程序可以独立运行，而无需依赖外部的类路径或其他依赖项管理机制，自动部署。优点：分布式部署方便<br>
War包：传统 Web 项目需要手动部署，使用 war 包在 Web 容器中启动。<br>
通过 SpringApplicationBuilder 或 SpringApplication 静态方法可以直接创建 SpringApplication 实例来直接启动应用程序。</li>
<li>嵌入式 Web 容器</li>
<li>约定大于配置<br>
简化了设置组件参数</li>
<li>自动配置(装配) Spring 和第三方库(starter)<br>
在 Spring Boot 中，采用约定优于配置的方式，根据类路径、包名、注解等自动装载 Bean。自动装载主应用程序类所在包、配置类所在包、@Component、第三方库中的类，无需显式配置 <code>@ComponentScan</code>。</li>
<li>运行时应用监控：服务器压力、内存占用、数据库负载</li>
</ul>
<h2 id="SpringApplication">SpringApplication</h2>
<p>SpringApplication 类用于从 Java Main方法引导和运行 Spring 应用。</p>
<p>引导步骤：</p>
<ol>
<li><strong>创建一个 ApplicationContext 实例</strong>(依赖你的类路径)<br>
<a href="../spring-core/%E6%A0%B8%E5%BF%83/spring_ioc.md#ApplicationContext">Spring IOC笔记#ApplicationContext</a></li>
</ol>
<ul>
<li>
<p>注册一个 CommandLinePropertySource 以暴露命令行参数作为 Spring properties，用于将命令行参数作为值注入到 Spring bean 中<br>
需要将 CommandLinePropertySource 添加到 ApplicationContext 的 Environment</p>
</li>
<li>
<p><strong>刷新 ApplicationContext</strong>，加载所有单例 Bean</p>
</li>
</ul>
<ul>
<li>触发所有实现了 CommandLineRunner 函数式接口的 Bean，用于在应用程序启动后，接收流量之前执行一些初始化任务</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProjectnameApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> SpringApplication.run(ProjectnameApplication.class, args);</span><br><span class="line">&#125;	&#125;</span><br></pre></td></tr></table></figure>
<p>方法：</p>
<p><code>SpringApplication.run(Class&lt;?&gt;, String...):ConfigurableApplicationContext</code></p>
<h3 id="run-Spring-Boot-启动流程">run() - Spring Boot 启动流程</h3>
<ol>
<li><strong>创建 SpringApplication 实例，再执行 run 方法</strong></li>
<li><strong>创建 Spring 应用运行监听器</strong> SpringApplicationRunListeners<br>
自动配置 spring.factories 中的 SpringApplicationRunListeners 注册到 IOC 容器。<br>
Spring 应用进行到某一阶段时会广播通知所有的监听器，监听器的方法被回调执行</li>
<li><strong>创建和配置环境</strong> prepareEnvironment<br>
<strong>加载系统环境变量、配置文件application.properties</strong></li>
<li><strong>创建应用上下文</strong> createApplicationContext<br>
None、Servlet、Reactive</li>
<li>prepareContext<br>
<strong>解析 Bean 配置信息为 Bean Definition</strong></li>
<li>refreshContext<br>
<strong>实例化 Bean，并注册到 IOC 容器</strong><br>
自动配置/装配、加载组件(组件扫描+DI，加载<code>@Component</code>、<code>@Entity</code>)、应用初始化(启动Web容器、初始化日志组件、数据源、连接池、数据池)</li>
<li>afterRefresh<br>
<strong>在上下文刷新后调用afterRefresh，空方法留给开发者自定义子类去实现</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ProjectNameApplication.java</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProjectNameApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  <span class="comment">// SpringBoot项目入口</span></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> SpringApplication.run(ProjectNameApplication.class, args);        </span><br><span class="line">&#125;	&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SpringApplication.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title function_">run</span><span class="params">(Class&lt;?&gt;[] primarySources, String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> <span class="title class_">SpringApplication</span>(primarySources)).run(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SpringApplication.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">SpringApplication</span><span class="params">(Class&lt;?&gt;... primarySources)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(<span class="literal">null</span>, primarySources);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SpringApplication.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">SpringApplication</span><span class="params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> &#123;  <span class="comment">// 创建 SpringApplication 实例，应用程序上下文从主要来源primarySources(当前启动类包)加载 Bean</span></span><br><span class="line">    <span class="built_in">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">    Assert.notNull(primarySources, <span class="string">&quot;PrimarySources must not be null&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.primarySources = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(Arrays.asList(primarySources));</span><br><span class="line">    <span class="built_in">this</span>.webApplicationType = WebApplicationType.deduceFromClasspath();</span><br><span class="line">    <span class="built_in">this</span>.bootstrapRegistryInitializers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(</span><br><span class="line">            getSpringFactoriesInstances(BootstrapRegistryInitializer.class));</span><br><span class="line">    setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));  <span class="comment">// 获取所有的配置在spring.factores中的ApplicationContextInitializer</span></span><br><span class="line">    setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));  <span class="comment">// 获取所有的配置在spring.factores中的ApplicationContextInitializer</span></span><br><span class="line">    <span class="built_in">this</span>.mainApplicationClass = deduceMainApplicationClass();  <span class="comment">// 推断启动类，得到FrameworkApplication.class</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SpringApplication.java</span></span><br><span class="line"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title function_">run</span><span class="params">(String... args)</span> &#123;  <span class="comment">// 运行Spring应用程序，创建并刷新一个新的ApplicationContext</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">    <span class="type">DefaultBootstrapContext</span> <span class="variable">bootstrapContext</span> <span class="operator">=</span> createBootstrapContext();</span><br><span class="line">    <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    configureHeadlessProperty();</span><br><span class="line">    <span class="type">SpringApplicationRunListeners</span> <span class="variable">listeners</span> <span class="operator">=</span> getRunListeners(args);  <span class="comment">// 1 实例化spring.factories中配置的所有SpringApplicationRunListener并返回到 listeners 中。SpringApplicationRunListeners内部是一个List&lt;SpringApplicationRunListener&gt;。spring应用进行到某一阶段时会广播通知所有的监听器, 监听器的方法就会被回调执行</span></span><br><span class="line">    listeners.starting(bootstrapContext, <span class="built_in">this</span>.mainApplicationClass); <span class="comment">//启动应用监听器，回调监听器的starting方法。</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">ApplicationArguments</span> <span class="variable">applicationArguments</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultApplicationArguments</span>(args);<span class="comment">//包装命令行启动参数</span></span><br><span class="line">        <span class="type">ConfigurableEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> prepareEnvironment(listeners, bootstrapContext, applicationArguments);  <span class="comment">// 2 准备应用环境, 包括读取系统环境变量、yml/properties等配置文件。同时回调listeners的environmentPrepared方法</span></span><br><span class="line">        <span class="type">Banner</span> <span class="variable">printedBanner</span> <span class="operator">=</span> printBanner(environment);  <span class="comment">// 打印Banner(Spring logo)，可以自定义</span></span><br><span class="line">        context = createApplicationContext();  <span class="comment">// 3 创建一个新的ApplicationContext</span></span><br><span class="line">        context.setApplicationStartup(<span class="built_in">this</span>.applicationStartup);</span><br><span class="line">        prepareContext(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner);  <span class="comment">// 4 上下文准备，会广播通知 listeners 执行 contextPrepared 回调方法</span></span><br><span class="line">        refreshContext(context);  <span class="comment">// 5 刷新上下文</span></span><br><span class="line">        afterRefresh(context, applicationArguments);  <span class="comment">// 6 收尾工作</span></span><br><span class="line">        <span class="type">Duration</span> <span class="variable">timeTakenToStartup</span> <span class="operator">=</span> Duration.ofNanos(System.nanoTime() - startTime);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.logStartupInfo) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">StartupInfoLogger</span>(<span class="built_in">this</span>.mainApplicationClass).logStarted(getApplicationLog(), timeTakenToStartup);</span><br><span class="line">        &#125;</span><br><span class="line">        listeners.started(context, timeTakenToStartup);</span><br><span class="line">        callRunners(context, applicationArguments);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123; ...        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (context.isRunning()) &#123;</span><br><span class="line">            <span class="type">Duration</span> <span class="variable">timeTakenToReady</span> <span class="operator">=</span> Duration.ofNanos(System.nanoTime() - startTime);</span><br><span class="line">            listeners.ready(context, timeTakenToReady);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123; ...       </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="createApplicationContext">createApplicationContext()</h4>
<p>创建默认 IOC 容器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// // SpringApplication.java</span></span><br><span class="line"><span class="keyword">protected</span> ConfigurableApplicationContext <span class="title function_">createApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.applicationContextFactory.create(<span class="built_in">this</span>.webApplicationType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DefaultApplicationContextFactory.java</span></span><br><span class="line"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title function_">create</span><span class="params">(WebApplicationType webApplicationType)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getFromSpringFactories(webApplicationType, ApplicationContextFactory::create,</span><br><span class="line">                <span class="built_in">this</span>::createDefaultApplicationContext);  <span class="comment">// </span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) &#123; ...</span><br><span class="line">&#125;	&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DefaultApplicationContextFactory.java</span></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; T <span class="title function_">getFromSpringFactories</span><span class="params">(WebApplicationType webApplicationType,</span></span><br><span class="line"><span class="params">        BiFunction&lt;ApplicationContextFactory, WebApplicationType, T&gt; action, Supplier&lt;T&gt; defaultResult)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (ApplicationContextFactory candidate : SpringFactoriesLoader.loadFactories(ApplicationContextFactory.class,</span><br><span class="line">            getClass().getClassLoader())) &#123;</span><br><span class="line">        <span class="comment">// (ServletWebServerApplicationContextFactory,&quot;SERVLET&quot;)</span></span><br><span class="line">        <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> action.apply(candidate, webApplicationType);          </span><br><span class="line">        <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">    &#125;	&#125;</span><br><span class="line">    <span class="keyword">return</span> (defaultResult != <span class="literal">null</span>) ? defaultResult.get() : <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ServletWebServerApplicationContextFactory.java</span></span><br><span class="line"><span class="keyword">private</span> ConfigurableApplicationContext <span class="title function_">createContext</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!AotDetector.useGeneratedArtifacts()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigServletWebServerApplicationContext</span>();  <span class="comment">// 默认的IOC容器</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServletWebServerApplicationContext</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="refreshContext">refreshContext()</h4>
<p><code>refresh():void</code> 初始化/刷新底层 ApplicationContext。从给定的 XML 文件中加载所有 BeanDefinition 并实例化初始化 Bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SpringApplication.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refreshContext</span><span class="params">(ConfigurableApplicationContext context)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.registerShutdownHook) &#123;</span><br><span class="line">        shutdownHook.registerApplicationContext(context);</span><br><span class="line">    &#125;</span><br><span class="line">    refresh(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SpringApplication.java</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">(ConfigurableApplicationContext applicationContext)</span> &#123;</span><br><span class="line">    applicationContext.refresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ServletWebServerApplicationContext.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.refresh();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">        <span class="type">WebServer</span> <span class="variable">webServer</span> <span class="operator">=</span> <span class="built_in">this</span>.webServer;</span><br><span class="line">        <span class="keyword">if</span> (webServer != <span class="literal">null</span>) &#123;</span><br><span class="line">            webServer.stop();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">&#125;	&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>refresh()方法过程</th>
<th>具体工作</th>
</tr>
</thead>
<tbody>
<tr>
<td>prepareRefresh()</td>
<td>标准初始化工作</td>
</tr>
<tr>
<td>obtainFreshBeanFactory()</td>
<td>获取ConfigurableListableBeanFactory，调用 <code>loadBeanDefinitions(DefaultListableBeanFactory):void</code> 将 BeanDefinition 加载到给定的 BeanFactory，委托给 BeanDefinitionReaders加载并解析 XML 文件为 BeanDefinition</td>
</tr>
<tr>
<td>prepareBeanFactory(beanFactory)</td>
<td></td>
</tr>
<tr>
<td>postProcessBeanFactory(beanFactory)</td>
<td>模板方法具体功能由子类实现</td>
</tr>
<tr>
<td>invokeBeanFactoryPostProcessors(beanFactory)</td>
<td>初始化Bean工厂后置处理器(JDK动态代理增强)</td>
</tr>
<tr>
<td>registerBeanPostProcessors(beanFactory)</td>
<td>注册Bean后置处理器(JDK动态代理增强)</td>
</tr>
<tr>
<td>initMessageSource()</td>
<td>国际化处理</td>
</tr>
<tr>
<td>initApplicationEventMulticaster()</td>
<td>初始化应用消息广播器</td>
</tr>
<tr>
<td>onRefresh()</td>
<td>模板方法具体功能由子类实现</td>
</tr>
<tr>
<td>registerListeners()</td>
<td>注册监听器</td>
</tr>
<tr>
<td>finishBeanFactoryInitialization(beanFactory)</td>
<td>实例化Bean<br />填充属性<br />调用初始化方法(afterPropertiesSet(), init())<br />调用BeanPostProcessor(生成Bean代理)</td>
</tr>
<tr>
<td>finishRefresh()</td>
<td>完成上下文的刷新</td>
</tr>
</tbody>
</table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractApplicationContext.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;</span><br><span class="line">	<span class="keyword">synchronized</span> (<span class="built_in">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">        <span class="type">StartupStep</span> <span class="variable">contextRefresh</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationStartup.start(<span class="string">&quot;spring.context.refresh&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 为刷新准备Context</span></span><br><span class="line">        prepareRefresh();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 告诉子类刷新内部BeanFactory</span></span><br><span class="line">        <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 为使用Context准备BeanFactory</span></span><br><span class="line">        prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 允许在Context子类中进行BeanFactory的后置处理PostProcess</span></span><br><span class="line">            postProcessBeanFactory(beanFactory);  <span class="comment">// 自定义扩展点</span></span><br><span class="line"></span><br><span class="line">            <span class="type">StartupStep</span> <span class="variable">beanPostProcess</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationStartup.start(<span class="string">&quot;spring.context.beans.post-process&quot;</span>);</span><br><span class="line">            <span class="comment">// 激活BanFactory的PostProcessor作为Bean到Context</span></span><br><span class="line">            invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 注册拦截创建Bean的PostProcessors</span></span><br><span class="line">            registerBeanPostProcessors(beanFactory);</span><br><span class="line">            beanPostProcess.end();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 为了Context初始化MessageSource</span></span><br><span class="line">            initMessageSource();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 为了Context初始化EventMulticaster</span></span><br><span class="line">            initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 初始化在特定Context子类中特定的Bean</span></span><br><span class="line">            onRefresh();  <span class="comment">// 自定义扩展点</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 查找并注册listener</span></span><br><span class="line">            registerListeners();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 实例化所有剩余的非懒初始化的单例Bean</span></span><br><span class="line">            finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 最后一步: 发布相应的事件</span></span><br><span class="line">            finishRefresh();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Destroy already created singletons to avoid dangling resources(未被正确释放的资源).</span></span><br><span class="line">            destroyBeans();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Reset &#x27;active&#x27; flag.</span></span><br><span class="line">            cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Propagate exception to caller.</span></span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// Reset common introspection caches in Spring&#x27;s core, since we</span></span><br><span class="line">            <span class="comment">// might not ever need metadata for singleton beans anymore...</span></span><br><span class="line">            resetCommonCaches();</span><br><span class="line">            contextRefresh.end();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CommandLineRunner">CommandLineRunner</h3>
<p>可以在同一Application 的上下文中定义多个 CommandLineRunner 或 ApplicationRunner，并且能够使用 <code>@Order</code>  注解进行按特定顺序调用的排序</p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppRunner</span> <span class="keyword">implements</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(AppRunner.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BookRepository bookRepository;</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">AppRunner</span><span class="params">(BookRepository bookRepository)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.bookRepository = bookRepository;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception &#123;  <span class="comment">// 用于运行Bean的回调函数</span></span><br><span class="line">		logger.info(<span class="string">&quot;.... Fetching books&quot;</span>);</span><br><span class="line">		logger.info(<span class="string">&quot;isbn-1234 --&gt;&quot;</span> + bookRepository.getByIsbn(<span class="string">&quot;isbn-1234&quot;</span>));</span><br><span class="line">		....</span><br><span class="line">&#125;	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="SpringApplicationBuilder">SpringApplicationBuilder</h2>
<p>构建 SpringApplication 和 ApplicationContext 实例，还可以设置活动配置文件，默认属性。</p>
<p>方法：</p>
<p><code>banner(Banner)</code></p>
<p><code>bannerMode(Banner.Mode)</code></p>
<p><code>context()</code></p>
<p><code>build(String...)</code></p>
<p><code>web(WebApplicationType)</code></p>
<p><code>listeners(ApplicationListener)</code> 监听 SpringApplication 事件，推荐 SpringApplicationRunListener 粒度更细</p>
<p><code>run(String...)</code></p>
<p><code>parent(Class&lt;?&gt;)</code></p>
<p><code>parent(ConfigurableApplicationContext)</code></p>
<p><code>profiles(String...)</code></p>
<p><code>properties(String...)</code></p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplicationBuilder</span>(Application.class)</span><br><span class="line">    	.profiles(<span class="string">&quot;server&quot;</span>)</span><br><span class="line">    	.properties(<span class="string">&quot;transport=local&quot;</span>).run(args);</span><br></pre></td></tr></table></figure>
<h2 id="SpringApplicationRunListener">SpringApplicationRunListener</h2>
<p>侦听 SpringApplication 运行方法。SpringApplicationRunListeners 是通过 SpringFactoriesLoader 加载的，每次运行都会创建一个新的SpringApplicationRunListener实例。<br>
应该声明一个接受 SpringApplication 实例和String[]参数的公共构造函数。</p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomSpringApplicationRunListener</span> <span class="keyword">implements</span> <span class="title class_">SpringApplicationRunListener</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> SpringApplication application;</span><br><span class="line">    <span class="keyword">private</span> String[] args;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyRunListener</span><span class="params">(SpringApplication application, String[] args)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.application = application;</span><br><span class="line">        <span class="built_in">this</span>.args = args;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">starting</span><span class="params">(ConfigurableBootstrapContext bootstrapContext)</span> &#123;</span><br><span class="line">        <span class="comment">// 可以输出SpringApplication和args信息。</span></span><br><span class="line">        System.out.println(<span class="string">&quot;CustomSpringApplicationRunListener: Application starting...&quot;</span>);</span><br><span class="line">        SpringApplicationRunListener.<span class="built_in">super</span>.starting(bootstrapContext);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">environmentPrepared</span><span class="params">(ConfigurableBootstrapContext bootstrapContext, ConfigurableEnvironment environment)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;CustomSpringApplicationRunListener: Environment prepared.&quot;</span>);</span><br><span class="line">        SpringApplicationRunListener.<span class="built_in">super</span>.environmentPrepared(bootstrapContext, environment);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextPrepared</span><span class="params">(ConfigurableApplicationContext context)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;CustomSpringApplicationRunListener: Context prepared.&quot;</span>);</span><br><span class="line">        SpringApplicationRunListener.<span class="built_in">super</span>.contextPrepared(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextLoaded</span><span class="params">(ConfigurableApplicationContext context)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;CustomSpringApplicationRunListener: Context loaded.&quot;</span>);</span><br><span class="line">        SpringApplicationRunListener.<span class="built_in">super</span>.contextLoaded(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">started</span><span class="params">(ConfigurableApplicationContext context, Duration timeTaken)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;CustomSpringApplicationRunListener: Application started.&quot;</span>);</span><br><span class="line">        SpringApplicationRunListener.<span class="built_in">super</span>.started(context, timeTaken);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">ready</span><span class="params">(ConfigurableApplicationContext context, Duration timeTaken)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;CustomSpringApplicationRunListener: Application ready.&quot;</span>);</span><br><span class="line">        SpringApplicationRunListener.<span class="built_in">super</span>.ready(context, timeTaken);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(ConfigurableApplicationContext context, Throwable exception)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;CustomSpringApplicationRunListener: Application failed to start.&quot;</span>);</span><br><span class="line">        SpringApplicationRunListener.<span class="built_in">super</span>.failed(context, exception);</span><br><span class="line">&#125;	&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.SpringApplicationRunListener = \ cn.cxc.framework.listener.CustomSpringApplicationRunListener</span><br></pre></td></tr></table></figure>
<h2 id="1加依赖">1加依赖</h2>
<h3 id="SPI机制">SPI机制</h3>
<p>Service Provider Interface 服务提供接口 = 基于Interface + 策略模式 + 配置文件(将变化隔离)，配置文件适合整体解决方案的变化<br>
@Primary @条件注解，适合具体类/对象的变化  <a href="../spring-core/%E6%A0%B8%E5%BF%83/spring_ioc.md#%E9%85%8D%E7%BD%AE%E7%B1%BB">Spring IOC笔记#条件注解</a></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">					 方案<span class="selector-tag">A</span></span><br><span class="line">调用方 - 标准服务接口 - 方案<span class="selector-tag">B</span></span><br><span class="line">					 方案C</span><br></pre></td></tr></table></figure>
<p>Java SPI 机制：在 <code>src/main/resources/META-INF/services</code> 目录， 新增一个以接口命名的文件，使用 <code>java.util.ServiceLoader</code> 来加载配置文件中指定的实现。例如<code>mysql-connector-java-8.0.18.jar</code> 采用原生 SPI 机制，就有一个 <code>/META-INF/services/java.sql.Driver</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.mysql.cj.jdbc.Driver</span><br></pre></td></tr></table></figure>
<p>Spring Boot 是 Java SPI 机制的变种，</p>
<h3 id="Starter">Starter</h3>
<p>Starter 包是特殊的 JAR 包，将 jar 添加到类路径，包含一组预配置和依赖项。<br>
有的提供 <code>@EnableXXX</code> 注解和配置类</p>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/dependency-versions.html#appendix.dependency-versions">Spring Boot 管理的依赖</a></p>
<table>
<thead>
<tr>
<th>ArtifactId 构建ID</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>spring-boot-starter-web</td>
<td>整合 SpringMVC，提供 Web 支持</td>
</tr>
<tr>
<td>spring-boot-starter-data-jpa</td>
<td>对 JPA 支持，集成 Hibernate</td>
</tr>
<tr>
<td>spring-boot-starter-logging</td>
<td>增加logback日志的支持</td>
</tr>
<tr>
<td>spring-boot-starter-test</td>
<td>整合 Unit 单元测试</td>
</tr>
<tr>
<td>spring-boot-starter-parent</td>
<td>提供默认 maven，提供依赖管理以省略 version 标签</td>
</tr>
<tr>
<td>spring-boot-starter-actuator</td>
<td>监控和管理应用程序，提供导航端点<br /><a target="_blank" rel="noopener" href="http://localhost:8080/actuator">http://localhost:8080/actuator</a></td>
</tr>
<tr>
<td><strong>第三方</strong></td>
<td></td>
</tr>
<tr>
<td>mybatis-spring-boot-starter</td>
<td>整合 Mybatis</td>
</tr>
</tbody>
</table>
<h3 id="实现">实现</h3>
<p>**自己实现 @EnalbeXX 注解和 ImportSelector 接口 **</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(StarterSelector.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableStarterConfigration &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StarterSelector</span> <span class="keyword">implements</span> <span class="title class_">ImportSelector</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;StarterConfigration.class.getName()&#125;;</span><br><span class="line">&#125;	&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StarterConfigration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MyDo <span class="title function_">myDo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyDo</span>();</span><br><span class="line">&#125;	&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableStarterConfigration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TryStarterApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">SpringApplicationBuilder</span>(TryStarterApplication.class)</span><br><span class="line">                        .web(WebApplicationType.NONE)  <span class="comment">// 不启动web容器</span></span><br><span class="line">                        .run(args);</span><br><span class="line">        <span class="type">IDo</span> <span class="variable">myDo</span> <span class="operator">=</span> (IDo) context.getBean(<span class="string">&quot;myDo&quot;</span>);</span><br><span class="line">        myDo.doSomething();  <span class="comment">// 成功自动装配</span></span><br><span class="line">&#125;	&#125;</span><br></pre></td></tr></table></figure>
<p><strong>利用@EnableAutoConfiguration和\META-INF\spring.factories</strong></p>
<p>为了让 Spring Boot 自动发现您的自动配置类，您可能需要将其所在的包或模块添加到 <code>spring.factories</code> 文件(用于声明自动配置类)中</p>
<p>这样，当其他项目引入您的自动配置依赖项时，Spring Boot 将自动加载并应用您的自动配置类。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">  cn.cxc.demo.StarterConfigration</span><br></pre></td></tr></table></figure>
<h3 id="自动配置">自动配置</h3>
<p>Spring Boot 的自动装配机制会试图根据你所添加的依赖来自动配置你的Spring应用程序。 例如，如果你添加了 <code>HSQLDB</code> 依赖，而且你没有手动配置任何 DataSource Bean，那么 Spring Boot 就会自动配置内存数据库。</p>
<p>你需要将 <code>@EnableAutoConfiguration</code> 或 <code>@SpringBootApplication</code> 注解添加一个主要的 <code>@Configuration</code> 类上，从而开启自动配置功能。</p>
<p>具体过程：当应用程序引入特定的 Starter 包后，Spring Boot 会自动扫描该 Starter 包中的配置类，并根据条件判断(条件注解)是否应用这些自动配置。这样应用程序就可以自动获取所需的功能和设置，而无需显式进行繁琐的配置。<strong>本质就是 <code>@Import</code> 注解导入第三方配置类和Bean到 IOC 容器中。</strong></p>
<p><code>@Component</code> 或 @<code>Configration</code>注解，只能装载自己项目中的源码库</p>
<h4 id="原理">原理</h4>
<p>自动配置原理就是，有一个 <code>@EnableXXX</code> 注解装载第三方模块，其中包含 <code>@Import</code> 注解导入 <code>Selector</code> 导包选择器类实例到 IOC 容器中，通过 <code>selector.selectImports()</code> 读取 <code>META-INF/spring/full-qualified-annotation-name.imports</code> 文件中配置类的<strong>全类名</strong>，来注册配置类和其中的 Bean 到 IOC 容器，最终装载了第三方模块。</p>
<p>Spring2.7之前读取 <code>META-INF/spring.factories</code> 文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootConfiguration</span>  <span class="comment">// 标识该类为配置类，配置类用于定义Bean配置信息</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span>  <span class="comment">// 启用 Spring Application Context 的自动配置功能，装配自动配置模块到classpath上</span></span><br><span class="line"><span class="meta">@ComponentScan</span>  <span class="comment">// 用于扫描同级目录以下的 bean 加入到 IOC 容器中</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootConfiguration &#123;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>spring-boot-autoconfigration.jar 是 SpringBoot 内置配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfigurationPackage</span>  <span class="comment">// 将@SpringBootApplication主配置类所在的包下面所有的组件都扫描注冊到 spring 容器中</span></span><br><span class="line"><span class="meta">@Import(AutoConfigurationImportSelector.class)</span>  <span class="comment">// 导入 AutoConfigurationImportSelector 类实例到 IOC 容器中</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAutoConfiguration &#123;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector.java  // 导包选择器</span></span><br><span class="line"><span class="comment">// 获取要导入的自动配置类的全类名。即扫描spring.factories文件并返回其中Configuration类的全类名</span></span><br><span class="line"><span class="keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isEnabled(annotationMetadata)) &#123;</span><br><span class="line">        <span class="keyword">return</span> NO_IMPORTS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">AutoConfigurationEntry</span> <span class="variable">autoConfigurationEntry</span> <span class="operator">=</span> getAutoConfigurationEntry(annotationMetadata);  <span class="comment">// </span></span><br><span class="line">    <span class="keyword">return</span> StringUtils.toStringArray(autoConfigurationEntry.getConfigurations());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector.java</span></span><br><span class="line"><span class="comment">// 根据导入的@Configuration类的AnnotationMetadata返回AutoConfigurationImportSelector.AutoConfigurationEntry</span></span><br><span class="line"><span class="keyword">protected</span> AutoConfigurationEntry <span class="title function_">getAutoConfigurationEntry</span><span class="params">(AnnotationMetadata annotationMetadata)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isEnabled(annotationMetadata)) &#123;</span><br><span class="line">        <span class="keyword">return</span> EMPTY_ENTRY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">AnnotationAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> getAttributes(annotationMetadata);</span><br><span class="line">    List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata, attributes);</span><br><span class="line">    configurations = removeDuplicates(configurations);</span><br><span class="line">    Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes);</span><br><span class="line">    checkExcludedClasses(configurations, exclusions);</span><br><span class="line">    configurations.removeAll(exclusions);</span><br><span class="line">    configurations = getConfigurationClassFilter().filter(configurations);</span><br><span class="line">    fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AutoConfigurationEntry</span>(configurations, exclusions);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector.java</span></span><br><span class="line"><span class="comment">// 获取候选配置类的全类名类List</span></span><br><span class="line"><span class="keyword">protected</span> List&lt;String&gt; <span class="title function_">getCandidateConfigurations</span><span class="params">(AnnotationMetadata metadata, AnnotationAttributes attributes)</span> &#123;</span><br><span class="line">    List&lt;String&gt; configurations = ImportCandidates.load(AutoConfiguration.class, getBeanClassLoader())</span><br><span class="line">        .getCandidates();  <span class="comment">// </span></span><br><span class="line">    Assert.notEmpty(configurations,</span><br><span class="line">            <span class="string">&quot;No auto configuration classes found in &quot;</span></span><br><span class="line">                    + <span class="string">&quot;META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports. If you &quot;</span></span><br><span class="line">                    + <span class="string">&quot;are using a custom packaging, make sure that file is correct.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> configurations;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ImportCandidates.java</span></span><br><span class="line"><span class="comment">// 从 classpath 中加载候选导入文件的名称。候选导入类的名称存储在 classpath 上名为META-INF/spring/full-qualified-annotation-name.imports的文件中</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ImportCandidates <span class="title function_">load</span><span class="params">(Class&lt;?&gt; annotation, ClassLoader classLoader)</span> &#123;</span><br><span class="line">    Assert.notNull(annotation, <span class="string">&quot;&#x27;annotation&#x27; must not be null&quot;</span>);</span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">classLoaderToUse</span> <span class="operator">=</span> decideClassloader(classLoader);</span><br><span class="line">    <span class="type">String</span> <span class="variable">location</span> <span class="operator">=</span> String.format(LOCATION, annotation.getName());</span><br><span class="line">    Enumeration&lt;URL&gt; urls = findUrlsInClasspath(classLoaderToUse, location);</span><br><span class="line">    List&lt;String&gt; importCandidates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> urls.nextElement();</span><br><span class="line">        importCandidates.addAll(readCandidateConfigurations(url));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ImportCandidates</span>(importCandidates);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector.java</span></span><br><span class="line"><span class="keyword">protected</span> List&lt;AutoConfigurationImportFilter&gt; <span class="title function_">getAutoConfigurationImportFilters</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> SpringFactoriesLoader.loadFactories(AutoConfigurationImportFilter.class, <span class="built_in">this</span>.beanClassLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TODO: 有空看看这个类 SpringFactoriesLoader.java，了解自动装配</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SpringFactoriesLoader</span></span><br><span class="line"><span class="comment">// 创建SpringFactoriesLoader实例，使用指定的类加载器从指定位置META-INF/spring.factories加载并实例化工厂实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> SpringFactoriesLoader <span class="title function_">forDefaultResourceLocation</span><span class="params">(<span class="meta">@Nullable</span> ClassLoader classLoader)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> forResourceLocation(FACTORIES_RESOURCE_LOCATION, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>spring.factories 文件用于指定当前 SDK 需要装载的配置类。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># C:\Users\qq109\.m2\repository\org\springframework\boot\spring-boot-autoconfigure\2.2.2.RELEASE\spring-boot-autoconfigure-2.2.2.RELEASE.jar!\META-INF\spring.factories</span><br><span class="line"># Initializers</span><br><span class="line">org.springframework.context.ApplicationContextInitializer=\</span><br><span class="line">org.springframework.boot.autoconfigure.SharedMetadataReaderFactoryContextInitializer,\</span><br><span class="line">org.springframework.boot.autoconfigure.logging.ConditionEvaluationReportLoggingListener</span><br><span class="line"></span><br><span class="line"># Application Listeners</span><br><span class="line">org.springframework.context.ApplicationListener=\</span><br><span class="line">org.springframework.boot.autoconfigure.BackgroundPreinitializer</span><br><span class="line"></span><br><span class="line"># Auto Configuration Import Listeners</span><br><span class="line">org.springframework.boot.autoconfigure.AutoConfigurationImportListener=\</span><br><span class="line">org.springframework.boot.autoconfigure.condition.ConditionEvaluationReportAutoConfigurationImportListener</span><br><span class="line"></span><br><span class="line"># Auto Configuration Import Filters</span><br><span class="line">org.springframework.boot.autoconfigure.AutoConfigurationImportFilter=\</span><br><span class="line">org.springframework.boot.autoconfigure.condition.OnBeanCondition,\</span><br><span class="line">org.springframework.boot.autoconfigure.condition.OnClassCondition,\</span><br><span class="line">org.springframework.boot.autoconfigure.condition.OnWebApplicationCondition</span><br><span class="line"></span><br><span class="line"># Auto Configure</span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\</span><br><span class="line">....</span><br></pre></td></tr></table></figure>
<h2 id="3写配置">3写配置</h2>
<p>属性配置比配置类优先级更高，配置类存在父子上下文重复扫描问题</p>
<p>常用的配置管理方式</p>
<p>1 与 jar 包同级的外部配置文件<br>
2 自动加载 resource 目录下的配置文件 <code>application-&#123;profile&#125;.properties</code> 或 <code>application-&#123;profile&#125;.yml</code><br>
3 配置项为 ${SOME_ENV} 使用环境变量或命令行参数<code>java -jar xxx.jar --key1.key11=value</code></p>
<p>application-{profile}.yml<br>
yaml 可以保证配置顺序(properties无序)，&quot;*&quot;一定要加引号(properties不需要)</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">key1:</span></span><br><span class="line">  <span class="attr">key11:</span> <span class="string">value1,</span> <span class="string">value2</span></span><br><span class="line">  <span class="attr">key22:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">value3</span>  <span class="comment"># - 表示列表</span></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html#appendix.application-properties">常用 Spring Boot 属性列表</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">debug:</span> <span class="literal">true</span>  <span class="comment"># 调试模式，debug模式下会打印自动装配项目以及触发自动装配的条件</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">    <span class="attr">level:</span></span><br><span class="line">      <span class="attr">org.springframework.web:</span> <span class="string">DEBUG</span></span><br><span class="line">      <span class="attr">org.hibernate:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="attr">file:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">trymylog</span>  <span class="comment"># 日志文件输出路径</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">servlet.context-path:</span> <span class="string">/</span> <span class="comment"># 设置应用上下文</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">mvc:</span></span><br><span class="line">    <span class="attr">log-request-details:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">    <span class="attr">banner-mode:</span> <span class="string">&quot;off&quot;</span></span><br><span class="line">  <span class="attr">jackson:</span></span><br><span class="line">    <span class="attr">time-zone:</span> <span class="string">GMT+8</span>  <span class="comment"># 必需  # 2023-09-30T00:37:18.000+08:00 时区+8</span></span><br><span class="line">    <span class="attr">date-format:</span> <span class="string">yyyy-MM-dd</span> <span class="string">HH:mm:ss</span></span><br><span class="line">    <span class="attr">property-naming- strategy:</span> <span class="string">SNAKE_CASE</span></span><br><span class="line">    <span class="attr">serialization:</span></span><br><span class="line">      <span class="attr">WRITE_DATES_AS_TIMESTAMPS:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/user_center</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> </span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">hikari:</span>  <span class="comment"># 数据库连接池</span></span><br><span class="line">      <span class="attr">maximum-pool-size:</span> <span class="number">10</span>    </span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">import:</span>  <span class="comment"># 导入外部配置文件</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">classpath:application-nacos.yml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">classpath:application-actuator.yml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">optional:nacos:dev.yml</span>  <span class="comment"># 监听nacos配置中心的DEFAULT_GROUP:dev.yml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">optional:nacos:aaa.yml?group=group_01&amp;refreshEnabled=false</span> <span class="comment"># 不开启动态刷新</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span>  <span class="comment"># 指定环境配置文件application-&#123;env&#125;.yml。profile: dev、prd</span></span><br><span class="line">    <span class="attr">group:</span>  <span class="comment"># 定义配置组的逻辑名称，为了关联配置  # 配合 spring.config.activate.on-profile使用</span></span><br><span class="line">      <span class="attr">dev:</span> <span class="string">dev-actuator,</span> <span class="string">dev-nacos</span></span><br><span class="line">      <span class="attr">prod:</span> <span class="string">prod-actuator,</span> <span class="string">prod-nacos</span></span><br></pre></td></tr></table></figure>
<h3 id="actuator">actuator</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">---</span> <span class="comment"># actuator</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">activate:</span></span><br><span class="line">      <span class="attr">on-profile:</span> <span class="string">dev-actuator</span>  <span class="comment"># profile表达式  # 配合spring.profiles.group使用</span></span><br><span class="line"><span class="attr">info:</span></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">try-spring-boot</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">0.1</span><span class="string">-SNAPSHOT</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Demo</span> <span class="string">project</span> <span class="string">for</span> <span class="string">Spring</span> <span class="string">Boot</span></span><br><span class="line">  <span class="attr">author:</span> <span class="string">&quot;Nemesis&quot;</span></span><br><span class="line">  <span class="attr">email:</span> <span class="string">&quot;chenxiangcheng1@gmail.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">health:</span></span><br><span class="line">      <span class="attr">show-details:</span> <span class="string">always</span>  <span class="comment"># 健康端点显示完整的健康信息</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">health,info</span>  <span class="comment"># 暴露健康端点和 info 端点，&quot;*&quot;暴露所有端点</span></span><br><span class="line">  <span class="attr">info:</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span>  <span class="comment"># 暴露 Environment 中名称以 info. 开头的任何属性</span></span><br></pre></td></tr></table></figure>
<h3 id="nacos">nacos</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">---</span> <span class="comment"># nacos</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">activate:</span></span><br><span class="line">      <span class="attr">on-profile:</span> <span class="string">dev-nacos</span>  <span class="comment"># profile表达式  # 配合spring.profiles.group使用</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">450cb8f7-64d4-4be0-8c5d-49b7450c2d6c</span>  <span class="comment"># Nacos命名空间ID</span></span><br><span class="line">        <span class="attr">cluster-name:</span> <span class="string">HZ</span>  <span class="comment"># Nacos集群名称</span></span><br><span class="line">        <span class="attr">metadata:</span></span><br><span class="line">          <span class="attr">instance:</span> <span class="string">content-center-instanceName</span></span><br><span class="line">          <span class="comment"># 自己这个实例的版本</span></span><br><span class="line">          <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">          <span class="comment"># 允许调用的提供者版本</span></span><br><span class="line">          <span class="attr">target-version:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">import:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">optional:nacos:dev.yml</span>  <span class="comment"># 监听nacos配置中心的DEFAULT_GROUP:dev.yml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">optional:nacos:aaa.yml?group=group_01&amp;refreshEnabled=false</span> <span class="comment"># 不开启动态刷新</span></span><br><span class="line">    <span class="attr">activate:</span></span><br><span class="line">      <span class="attr">on-profile:</span> <span class="string">nacos</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">user-center</span>  <span class="comment"># 服务名称尽量用-, 不要用_  # 作为Nacos服务名称</span></span><br></pre></td></tr></table></figure>
<h3 id="ribbon">ribbon</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">---</span> <span class="comment"># ribbon</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">activate:</span></span><br><span class="line">      <span class="attr">on-profile:</span> <span class="string">dev-ribbon</span>  <span class="comment"># profile表达式  # 配合spring.profiles.group使用</span></span><br><span class="line"><span class="string">&lt;clientName&gt;:</span>  <span class="comment"># 局部配置 - 当Ribbon调用xxx-center/service&lt;clientName&gt;时，使用RandomRule...配置的负载均衡器</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">	<span class="attr">NFLoadBalancerclassName:</span> <span class="string">ILoadBalancer实现类全路径</span></span><br><span class="line">	<span class="attr">NFLoadBalancerRuleclassName:</span> <span class="string">IRule实现类全路径</span></span><br><span class="line">	<span class="attr">NFLoadBalancerPingclassName:</span> <span class="string">IPing实现类全路径</span></span><br><span class="line">	<span class="attr">NIWSServerListclassName:</span> <span class="string">ServerList实现类全路径</span></span><br><span class="line">	<span class="attr">NIWSServerListFilterclassName:</span> <span class="string">ServerListFilter实现类全路径</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">eager-load:</span>  <span class="comment"># 创建和初始化负载均衡器LoadBalancer的时机，eager-load enabled饥饿加载、懒加载</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">clients:</span> <span class="string">user-center,xxx-service</span></span><br></pre></td></tr></table></figure>
<h2 id="2Spring-Boot-注解">2Spring Boot 注解</h2>
<table>
<thead>
<tr>
<th>注解</th>
<th>元注解Target</th>
<th>释义</th>
<th>成员变量</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>@SpringBootApplication</code></td>
<td>TYPE</td>
<td>=@SpringBootConfiguration+<br />@EnableAutoConfiguration+<br />@ComponentScan。标识该类为配置类，装配自动配置模块，启动组件扫描</td>
<td></td>
</tr>
<tr>
<td><code>@EnableXXXX</code></td>
<td></td>
<td>=@Import。启动XXX功能，装配模块。可以去看自动配置原理</td>
<td></td>
</tr>
<tr>
<td><code>@Import</code></td>
<td>TYPE</td>
<td>导入该类实例到 IOC 容器中</td>
<td><code>value():Class&lt;?&gt;[]</code></td>
</tr>
<tr>
<td><code>@AutoConfiguration</code></td>
<td>TYPE</td>
<td>标识该类提供了能被Spring Boot自动应用的配置，在指定的自动配置类之间应用，只影响定义 Bean 的顺序，不影响创建 Bean 的顺序<br />=@Configuration+@AutoConfigureBefore+@AutoConfigureAfter</td>
<td><code>before():Class&lt;?&gt;[]</code><br /><code>afters():Class&lt;?&gt;[]</code></td>
</tr>
<tr>
<td><code>@ConfigurationProperties</code></td>
<td>TYPE、@Configuration类中@Bean方法</td>
<td>外部配置多个属性注入，类型安全(编译时反馈)，需要创造一个 POJO</td>
<td>可绑定到该对象的有效属性的前缀</td>
</tr>
</tbody>
</table>
<h1>未整理</h1>
<h2 id="自动发现-统一注册">自动发现/统一注册</h2>
<p>springboot中 主要是发现 (优点，代码量少，缺点，资源分散，联系不明显)，而不是注册 (统一注册)</p>
<p>使类被 Spring 发现，需要使用特定的注解或者实现特定的接口</p>
<p>注册controller，发现controller</p>
<h2 id="访问托管的静态资源">访问托管的静态资源</h2>
<p>模板引擎渲染：在服务端把html页面渲染好再返回到前端<br>
静态资源一般存贮在 resources/static/ 下。<br>
如图片存在 resources/static/imgs/ 下，可以直接通过 localhost:8081/imgs/数字0.png 访问静态资源图片Content-Type会直接设置为对应的静态资源类型，如 image/png</p>
<p>前后端分离：服务端返回 Json数据，很少返回 html<br>
静态资源托管在 OSS 七牛 码云 单独构建一个Nginx服务 另外构建一个Springboot项目仅保存图片 当前的项目工程static中</p>
<h2 id="ValidationMessages-properties">ValidationMessages.properties</h2>
<p>文件名不能变：约定大于配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">id.positive</span> = <span class="string">id必须是正整数，可以带入参数&#123;min&#125;&#123;max&#125;</span></span><br><span class="line"><span class="attr">token.password</span> = <span class="string">password不符合规范：当前值是$&#123;validatedValue&#125;，最大值应该是&#123;max&#125;，最小值应该是&#123;min&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">$&#123;validatedValue&#125;：表示当前的需要校验的值</span></span><br></pre></td></tr></table></figure>
<p>JSR303校验的message模板配置：消除Controller参数校验注解的message<strong>硬编码</strong>：@Positive(message = “错误信息”)，该文件用于配置消息错误信息的配置</p>
<p>应用：@Positive(message = “{id.positive}”)，会抛出ConstraintViolationException异常，要在全局异常处理中处理（Constraint：约束，Violation：违反）</p>
<h2 id="SpringBoot-框架二次封装">SpringBoot 框架二次封装</h2>
<h3 id="全局异常处理">全局异常处理</h3>
<p>异常的分类<br>
Error<br>
Exeption：<br>
CheckedException：编译时异常<br>
RuntimeException：运行时异常</p>
<h4 id="controller">controller</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.api.v1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.zjbti.missyou.dto.PersonDTO;</span><br><span class="line"><span class="keyword">import</span> com.zjbti.missyou.service.BannerService;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.validator.constraints.Length;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.annotation.Validated;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.Max;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/1/25 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/banner&quot;)</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BannerController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BannerService bannerService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BannerController</span><span class="params">(BannerService bannerService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.bannerService = bannerService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    @GetMapping(&quot;/test&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &#123;&quot;/test/&#123;id1&#125;&quot;, &quot;/test1/&#123;id1&#125;&quot;&#125;, method = &#123;RequestMethod.GET, RequestMethod.POST&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> PersonDTO <span class="title function_">test</span><span class="params">(<span class="meta">@PathVariable(name = &quot;id1&quot;)</span> <span class="meta">@Max(value = 10, message = &quot;不可以超过10哦QAQ&quot;)</span> Integer id,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestParam(value = &quot;name&quot;)</span> <span class="meta">@Length(min = 2, max = 3)</span> String name,</span></span><br><span class="line"><span class="params">//                       <span class="meta">@RequestBody</span> Map&lt;String,Object&gt; person,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestBody</span> <span class="meta">@Validated</span> PersonDTO person,</span></span><br><span class="line"><span class="params">                       HttpServletResponse response)</span> &#123;</span><br><span class="line"><span class="comment">//        response.getWriter().write(&quot;hello你好&quot;);</span></span><br><span class="line"><span class="comment">//        throw new RuntimeException(&quot;123123&quot;);</span></span><br><span class="line"><span class="comment">//        PersonDTO personDTO = new PersonDTO(null,11);</span></span><br><span class="line"><span class="comment">//        PersonDTO personDTO = new PersonDTO();</span></span><br><span class="line"><span class="comment">//        personDTO.setName(&quot;c&quot;);</span></span><br><span class="line"><span class="comment">//        personDTO.setAge(15);</span></span><br><span class="line">        <span class="type">PersonDTO</span> <span class="variable">personDTO</span> <span class="operator">=</span> PersonDTO.builder().name(<span class="string">&quot;陈祥城&quot;</span>).age(<span class="number">18</span>).build();</span><br><span class="line"><span class="comment">//        dto.setAge(11);</span></span><br><span class="line">        <span class="keyword">return</span> personDTO;</span><br><span class="line"><span class="comment">//        throw new NotFoundException(10000);</span></span><br><span class="line"><span class="comment">//        return &quot;Hello你好呀&quot;;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="HttpException">HttpException</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.exception.http;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/1/28 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Integer code;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">Integer</span> <span class="variable">httpStatusCode</span> <span class="operator">=</span> <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getHttpStatusCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> httpStatusCode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="NotFoundException">NotFoundException</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.exception.http;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/1/28 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NotFoundException</span> <span class="keyword">extends</span> <span class="title class_">HttpException</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NotFoundException</span><span class="params">(<span class="type">int</span> code)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.httpStatusCode = <span class="number">404</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="GlobalExceptionAdvice-全局异常通知">GlobalExceptionAdvice 全局异常通知</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.zjbti.missyou.core.configration.ExceptionCodeConfigration;</span><br><span class="line"><span class="keyword">import</span> com.zjbti.missyou.exception.http.HttpException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 统一处理所有异常，并且返回到前端</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/1/27 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionAdvice</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ExceptionCodeConfigration codeConfigration;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = Exception.class)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ResponseStatus(code = HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">    <span class="keyword">public</span> UnifyResponse <span class="title function_">handleException</span><span class="params">(HttpServletRequest req, Exception e)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestUrl</span> <span class="operator">=</span> req.getRequestURI();</span><br><span class="line">        <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> req.getMethod();</span><br><span class="line">        System.out.println(e);</span><br><span class="line">        </span><br><span class="line">        <span class="type">UnifyResponse</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnifyResponse</span>(<span class="number">9999</span>, <span class="string">&quot;服务器内部错误&quot;</span>, method + <span class="string">&quot; &quot;</span> + requestUrl);</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 以这种方式处理异常</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = HttpException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;UnifyResponse&gt; <span class="title function_">handleHttpException</span><span class="params">(HttpServletRequest req, HttpException e)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestUrl</span> <span class="operator">=</span> req.getRequestURI();</span><br><span class="line">        <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> req.getMethod();</span><br><span class="line">        <span class="type">UnifyResponse</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnifyResponse</span>(e.getCode(), codeConfigration.getMessage(e.getCode()), method+ <span class="string">&quot; &quot;</span> + requestUrl);</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpStatus</span> <span class="variable">httpStatus</span> <span class="operator">=</span> HttpStatus.resolve(e.getHttpStatusCode());</span><br><span class="line"></span><br><span class="line">        ResponseEntity&lt;UnifyResponse&gt; r = <span class="keyword">new</span> <span class="title class_">ResponseEntity</span>&lt;&gt;(message, headers, httpStatus);</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="注解">注解</h4>
<table>
<thead>
<tr>
<th>注解</th>
<th>释义</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>GlobalExceptionAdvice</strong></td>
<td>全局异常通知</td>
</tr>
<tr>
<td>@ControllerAdvice</td>
<td>Controller 通知/增强，用于声明全局型的东西</td>
</tr>
<tr>
<td>@ExceptionHandler(value = Exception.class)</td>
<td>异常处理，注解标注的方法，用于<strong>捕获Controller中抛出的不同类型的异常</strong>，并进行处理返回，从而达到异常全局处理的目的</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>@ResponseStatus(code = HttpStatus.INTERNAL_SERVER_ERROR)</td>
<td>修改响应状态码，也可以通过ResposneEntity(message, headers, httpStatus) 的构造参数 httpStatus 改</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>ExceptionCodeConfigration</strong></td>
<td>异常码配置</td>
</tr>
<tr>
<td>@ConfigurationProperties(prefix=“lin”)</td>
<td>配置属性的前缀</td>
</tr>
<tr>
<td>@PropertySource(value = “classpath:config/exception-code.properties”)</td>
<td>配置属性数据源，会自动注入对应配置文件名的属性</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h4 id="配置异常码">配置异常码</h4>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">lin.codes[10000]</span> = <span class="string">通用异常</span></span><br><span class="line"><span class="attr">lin.codes[10001]</span> = <span class="string">通用参数错误</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="ExceptionCodeConfigration">ExceptionCodeConfigration</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.core.configration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.PropertySource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 避免根据异常码配置文件一个个注入，直接封装一个类，负责管理一个配置文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/1/28 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix=&quot;lin&quot;)</span></span><br><span class="line"><span class="meta">@PropertySource(value = &quot;classpath:config/exception-code.properties&quot;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExceptionCodeConfigration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Integer, String&gt; codes = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;Integer, String&gt; <span class="title function_">getCodes</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.codes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCodes</span><span class="params">(Map&lt;Integer, String&gt; codes)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.codes = codes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">(<span class="type">int</span> code)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> codes.get(code);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="UnifyResponse">UnifyResponse</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.core;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 序列化需要getter访问器，不然Spring序列化读取不到，会报错</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/1/28 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnifyResponse</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UnifyResponse</span><span class="params">(Integer code, String message, String url)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">        <span class="built_in">this</span>.url = url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUrl</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> url;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="根据目录自动路由前缀映射">根据目录自动路由前缀映射</h3>
<h4 id="AutoPrefixConfigration-通过config注入">AutoPrefixConfigration 通过config注入</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.core.configration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.zjbti.missyou.core.hack.AutoPrefixUrlMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.web.servlet.WebMvcRegistrations;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/1/31 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AutoPrefixConfigration</span> <span class="keyword">implements</span> <span class="title class_">WebMvcRegistrations</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RequestMappingHandlerMapping <span class="title function_">getRequestMappingHandlerMapping</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AutoPrefixUrlMapping</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="AutoPrefixUrlMapping-处理请求映射的类">AutoPrefixUrlMapping 处理请求映射的类</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.core.hack;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/1/31 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AutoPrefixUrlMapping</span> <span class="keyword">extends</span> <span class="title class_">RequestMappingHandlerMapping</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;missyou.api-package&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String apiPackagePath;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> RequestMappingInfo <span class="title function_">getMappingForMethod</span><span class="params">(Method method, Class&lt;?&gt; handlerType)</span> &#123;</span><br><span class="line">        <span class="type">RequestMappingInfo</span> <span class="variable">mappingInfo</span> <span class="operator">=</span> <span class="built_in">super</span>.getMappingForMethod(method, handlerType);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != mappingInfo) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">prefix</span> <span class="operator">=</span> <span class="built_in">this</span>.getPrefix(handlerType);</span><br><span class="line">            <span class="type">RequestMappingInfo</span> <span class="variable">newMappingInfo</span> <span class="operator">=</span> RequestMappingInfo.paths(prefix).build().combine(mappingInfo);</span><br><span class="line">            <span class="keyword">return</span> newMappingInfo;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mappingInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getPrefix</span><span class="params">(Class&lt;?&gt; handlerType)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> handlerType.getPackage().getName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">dotPath</span> <span class="operator">=</span> packageName.replaceAll(<span class="built_in">this</span>.apiPackagePath, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> dotPath.replace(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Java-Post参数校验-Spring全局异常处理">Java Post参数校验 + Spring全局异常处理</h3>
<h4 id="controller-2">controller</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.api.v1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.zjbti.missyou.dto.PersonDTO;</span><br><span class="line"><span class="keyword">import</span> com.zjbti.missyou.service.BannerService;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.validator.constraints.Length;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.annotation.Validated;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.Max;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/1/25 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/banner&quot;)</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BannerController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BannerService bannerService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BannerController</span><span class="params">(BannerService bannerService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.bannerService = bannerService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    @GetMapping(&quot;/test&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &#123;&quot;/test/&#123;id1&#125;&quot;, &quot;/test1/&#123;id1&#125;&quot;&#125;, method = &#123;RequestMethod.GET, RequestMethod.POST&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> PersonDTO <span class="title function_">test</span><span class="params">(<span class="meta">@PathVariable(name = &quot;id1&quot;)</span> <span class="meta">@Max(value = 10, message = &quot;不可以超过10哦QAQ&quot;)</span> Integer id,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestParam(value = &quot;name&quot;)</span> <span class="meta">@Length(min = 2, max = 3)</span> String name,</span></span><br><span class="line"><span class="params">//                       <span class="meta">@RequestBody</span> Map&lt;String,Object&gt; person,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestBody</span> <span class="meta">@Validated</span> PersonDTO person,</span></span><br><span class="line"><span class="params">                       HttpServletResponse response)</span> &#123;</span><br><span class="line"><span class="comment">//        response.getWriter().write(&quot;hello你好&quot;);</span></span><br><span class="line"><span class="comment">//        throw new RuntimeException(&quot;123123&quot;);</span></span><br><span class="line"><span class="comment">//        PersonDTO personDTO = new PersonDTO(null,11);</span></span><br><span class="line"><span class="comment">//        PersonDTO personDTO = new PersonDTO();</span></span><br><span class="line"><span class="comment">//        personDTO.setName(&quot;c&quot;);</span></span><br><span class="line"><span class="comment">//        personDTO.setAge(15);</span></span><br><span class="line">        <span class="type">PersonDTO</span> <span class="variable">personDTO</span> <span class="operator">=</span> PersonDTO.builder().name(<span class="string">&quot;陈祥城&quot;</span>).age(<span class="number">18</span>).build();</span><br><span class="line"><span class="comment">//        dto.setAge(11);</span></span><br><span class="line">        <span class="keyword">return</span> personDTO;</span><br><span class="line"><span class="comment">//        throw new NotFoundException(10000);</span></span><br><span class="line"><span class="comment">//        return &quot;Hello你好呀&quot;;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="DTO-使用自定义注解">DTO 使用自定义注解</h4>
<p>DTO：data transfer object数据传输对象，定义的是服务端接受到的数据对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.dto;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.zjbti.missyou.validators.PasswordEqual;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.validator.constraints.Length;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/2/1 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="comment">//@Setter</span></span><br><span class="line"><span class="comment">//@AllArgsConstructor</span></span><br><span class="line"><span class="comment">//@RequiredArgsConstructor</span></span><br><span class="line"><span class="comment">//@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="comment">//@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@PasswordEqual(min = 1,message = &quot;两次密码不相同&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PersonDTO</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @NonNull</span></span><br><span class="line">    <span class="meta">@Length(min=2, max = 10, message = &quot;name长度错误&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password1;</span><br><span class="line">    <span class="keyword">private</span> String password2;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    public String getName() &#123;</span></span><br><span class="line"><span class="comment">//        return name;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    public void setName(String name) &#123;</span></span><br><span class="line"><span class="comment">//        this.name = name;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    public Integer getAge() &#123;</span></span><br><span class="line"><span class="comment">//        return age;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    public void setAge(Integer age) &#123;</span></span><br><span class="line"><span class="comment">//        this.age = age;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="自定义注解">自定义注解</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.validators;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.Constraint;</span><br><span class="line"><span class="keyword">import</span> javax.validation.Payload;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/2/2 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.FIELD&#125;)</span></span><br><span class="line"><span class="comment">// 约束</span></span><br><span class="line"><span class="meta">@Constraint(validatedBy = PasswordValidator.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> PasswordEqual &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">min</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">4</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">max</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">6</span>;</span><br><span class="line">    String <span class="title function_">message</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;passwords are not equal&quot;</span>;</span><br><span class="line">    <span class="comment">// 自定义校验注解的两个规范方法</span></span><br><span class="line">    Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    Class&lt;? <span class="keyword">extends</span> <span class="title class_">Payload</span>&gt;[] payload() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="注解处理器-实现-ConstraintValidator-接口">注解处理器 实现 ConstraintValidator 接口</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.validators;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.zjbti.missyou.dto.PersonDTO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.ConstraintValidator;</span><br><span class="line"><span class="keyword">import</span> javax.validation.ConstraintValidatorContext;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现 ConstraintValidator接口，指定泛型第一个是自定义注解，第二个是自定义注解修饰的目标的类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/2/2 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PasswordValidator</span> <span class="keyword">implements</span> <span class="title class_">ConstraintValidator</span>&lt;PasswordEqual, PersonDTO&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> min;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> max;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(PasswordEqual constraintAnnotation)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.min = constraintAnnotation.min();</span><br><span class="line">        <span class="built_in">this</span>.max = constraintAnnotation.max();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isValid</span><span class="params">(PersonDTO personDTO, ConstraintValidatorContext constraintValidatorContext)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">password1</span> <span class="operator">=</span> personDTO.getPassword1();</span><br><span class="line">        <span class="type">String</span> <span class="variable">password2</span> <span class="operator">=</span> personDTO.getPassword2();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">match</span> <span class="operator">=</span> password1.equals(password2);</span><br><span class="line">        <span class="keyword">return</span> match;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="全局异常处理-2">全局异常处理</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zjbti.missyou.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.zjbti.missyou.core.configration.ExceptionCodeConfigration;</span><br><span class="line"><span class="keyword">import</span> com.zjbti.missyou.exception.http.HttpException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.ObjectError;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.MethodArgumentNotValidException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.validation.ConstraintViolationException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 统一处理所有异常，并且返回到前端</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/1/27 <span class="doctag">@Created</span> by cxc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionAdvice</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ExceptionCodeConfigration codeConfigration;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = Exception.class)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ResponseStatus(code = HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">    <span class="keyword">public</span> UnifyResponse <span class="title function_">handleException</span><span class="params">(HttpServletRequest req, Exception e)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestUrl</span> <span class="operator">=</span> req.getRequestURI();</span><br><span class="line">        <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> req.getMethod();</span><br><span class="line">        <span class="comment">// 打印未知异常，可高效查看异常和开发</span></span><br><span class="line">        System.out.println(e);</span><br><span class="line"></span><br><span class="line">        <span class="type">UnifyResponse</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnifyResponse</span>(<span class="number">9999</span>, <span class="string">&quot;服务器内部错误(未知异常)&quot;</span>, method + <span class="string">&quot; &quot;</span> + requestUrl);</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// HttpException异常发生，http状态码不相同，需要动态设置</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = HttpException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;UnifyResponse&gt; <span class="title function_">handleHttpException</span><span class="params">(HttpServletRequest req, HttpException e)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestUrl</span> <span class="operator">=</span> req.getRequestURI();</span><br><span class="line">        <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> req.getMethod();</span><br><span class="line">        <span class="type">UnifyResponse</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnifyResponse</span>(e.getCode(), codeConfigration.getMessage(e.getCode()), method+ <span class="string">&quot; &quot;</span> + requestUrl);</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpStatus</span> <span class="variable">httpStatus</span> <span class="operator">=</span> HttpStatus.resolve(e.getHttpStatusCode());</span><br><span class="line"></span><br><span class="line">        ResponseEntity&lt;UnifyResponse&gt; r = <span class="keyword">new</span> <span class="title class_">ResponseEntity</span>&lt;&gt;(message, headers, httpStatus);</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 参数异常，http状态码相同，不用动态设置，使用注解</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = MethodArgumentNotValidException.class)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ResponseStatus(code = HttpStatus.BAD_REQUEST)</span></span><br><span class="line">    <span class="keyword">public</span> UnifyResponse <span class="title function_">handleBeanValidation</span><span class="params">(HttpServletRequest req, MethodArgumentNotValidException e)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestUrl</span> <span class="operator">=</span> req.getRequestURI();</span><br><span class="line">        <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> req.getMethod();</span><br><span class="line"></span><br><span class="line">        List&lt;ObjectError&gt; errors = e.getBindingResult().getAllErrors();</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="built_in">this</span>.formatAllErrorMessages(errors);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UnifyResponse</span>(<span class="number">10001</span>, message, method + <span class="string">&quot; &quot;</span> + requestUrl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//	Constraint：约束	Violation：违反</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = ConstraintViolationException.class)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ResponseStatus(code = HttpStatus.BAD_REQUEST)</span></span><br><span class="line">    <span class="keyword">public</span> UnifyResponse <span class="title function_">handleConstraintViolationException</span><span class="params">(HttpServletRequest req, ConstraintViolationException e)</span> &#123;</span><br><span class="line">        <span class="comment">// 使用遍历自获取message，定义性更强</span></span><br><span class="line"><span class="comment">//        StringBuffer errorMsg = new StringBuffer();</span></span><br><span class="line"><span class="comment">//        for (ConstraintViolation error : e.getConstraintViolations()) &#123;</span></span><br><span class="line"><span class="comment">//            String msg = e.getMessage();</span></span><br><span class="line"><span class="comment">//            String m = error.getPropertyPath().toString();</span></span><br><span class="line"><span class="comment">//            String name = m.split(&quot;[.]&quot;)[1];</span></span><br><span class="line"><span class="comment">//            errorMsg.append(name).append(&quot; &quot;).append(msg).append(&quot;;&quot;);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        return new UnifyResponse(10001, errorMsg.toString(), requestUrl);</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">requestUrl</span> <span class="operator">=</span> req.getRequestURI();</span><br><span class="line">        <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> req.getMethod();</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> e.getMessage();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UnifyResponse</span>(<span class="number">10001</span>, message, method + <span class="string">&quot; &quot;</span> + requestUrl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">formatAllErrorMessages</span><span class="params">(List&lt;ObjectError&gt; errors)</span> &#123;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">errorMsg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        errors.forEach(error -&gt;</span><br><span class="line">                errorMsg.append(error.getDefaultMessage()).append(<span class="string">&#x27;;&#x27;</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> errorMsg.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>要知道要处理的异常类型，可以通过直接测试查看</p>
<p>MethodArgumentNotValidException：是当参数异常时抛出，配合@max、@min等注解使用</p>
<p>ConstraintViolationException：是配合Java原生的@Constraint注解 + Java原生的ConstraintValidator注解处理器 + Spring全局异常处理 使用</p>
<p>[<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/">https://docs.spring.io/spring-boot/docs/current/reference/html/</a>]:</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.haruharu.top">Nemesis</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.haruharu.top/articles/Dev/Spring/spring-boot/spring_boot3.2.0/">https://blog.haruharu.top/articles/Dev/Spring/spring-boot/spring_boot3.2.0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.haruharu.top" target="_blank">Nemesis</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/articles/Dev/Spring/spring-cloud/spring_cloud/" title=""><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info"></div></div></a></div><div class="next-post pull-right"><a href="/articles/Dev/nodejs/nodejs20.5.1/" title="Node.js"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Node.js</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Nemesis</div><div class="author-info__description">浙江外国语学院大四老人</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">69</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">34</div></a></div><a id="card-info-btn" href="mailto:chenxiangcheng1@gmail.com"><i class="fas fa-envelope"></i><span>Contact Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/chenxiangcheng1" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:chenxiangcheng1@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://space.bilibili.com/36033539" target="_blank" title="Bili"><i class="fa-brands fa-bilibili" style="color: #74C0FC;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">有空B站直播写代码 ( •̀ ω •́ )✧</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">Spring Boot</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%88%E6%9C%AC"><span class="toc-number">1.1.</span> <span class="toc-text">版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Boot-%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7"><span class="toc-number">1.2.</span> <span class="toc-text">Spring Boot 核心特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringApplication"><span class="toc-number">1.3.</span> <span class="toc-text">SpringApplication</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#run-Spring-Boot-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.1.</span> <span class="toc-text">run() - Spring Boot 启动流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#createApplicationContext"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">createApplicationContext()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#refreshContext"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">refreshContext()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CommandLineRunner"><span class="toc-number">1.3.2.</span> <span class="toc-text">CommandLineRunner</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringApplicationBuilder"><span class="toc-number">1.4.</span> <span class="toc-text">SpringApplicationBuilder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringApplicationRunListener"><span class="toc-number">1.5.</span> <span class="toc-text">SpringApplicationRunListener</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="toc-number">1.6.</span> <span class="toc-text">1加依赖</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SPI%E6%9C%BA%E5%88%B6"><span class="toc-number">1.6.1.</span> <span class="toc-text">SPI机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Starter"><span class="toc-number">1.6.2.</span> <span class="toc-text">Starter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.6.3.</span> <span class="toc-text">实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">1.6.4.</span> <span class="toc-text">自动配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.6.4.1.</span> <span class="toc-text">原理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E5%86%99%E9%85%8D%E7%BD%AE"><span class="toc-number">1.7.</span> <span class="toc-text">3写配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#actuator"><span class="toc-number">1.7.1.</span> <span class="toc-text">actuator</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nacos"><span class="toc-number">1.7.2.</span> <span class="toc-text">nacos</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ribbon"><span class="toc-number">1.7.3.</span> <span class="toc-text">ribbon</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2Spring-Boot-%E6%B3%A8%E8%A7%A3"><span class="toc-number">1.8.</span> <span class="toc-text">2Spring Boot 注解</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">未整理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0-%E7%BB%9F%E4%B8%80%E6%B3%A8%E5%86%8C"><span class="toc-number">2.1.</span> <span class="toc-text">自动发现&#x2F;统一注册</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%89%98%E7%AE%A1%E7%9A%84%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90"><span class="toc-number">2.2.</span> <span class="toc-text">访问托管的静态资源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ValidationMessages-properties"><span class="toc-number">2.3.</span> <span class="toc-text">ValidationMessages.properties</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringBoot-%E6%A1%86%E6%9E%B6%E4%BA%8C%E6%AC%A1%E5%B0%81%E8%A3%85"><span class="toc-number">2.4.</span> <span class="toc-text">SpringBoot 框架二次封装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">2.4.1.</span> <span class="toc-text">全局异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#controller"><span class="toc-number">2.4.1.1.</span> <span class="toc-text">controller</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HttpException"><span class="toc-number">2.4.1.2.</span> <span class="toc-text">HttpException</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NotFoundException"><span class="toc-number">2.4.1.3.</span> <span class="toc-text">NotFoundException</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GlobalExceptionAdvice-%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E9%80%9A%E7%9F%A5"><span class="toc-number">2.4.1.4.</span> <span class="toc-text">GlobalExceptionAdvice 全局异常通知</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E8%A7%A3"><span class="toc-number">2.4.1.5.</span> <span class="toc-text">注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%BC%82%E5%B8%B8%E7%A0%81"><span class="toc-number">2.4.1.6.</span> <span class="toc-text">配置异常码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ExceptionCodeConfigration"><span class="toc-number">2.4.1.7.</span> <span class="toc-text">ExceptionCodeConfigration</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UnifyResponse"><span class="toc-number">2.4.1.8.</span> <span class="toc-text">UnifyResponse</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E7%9B%AE%E5%BD%95%E8%87%AA%E5%8A%A8%E8%B7%AF%E7%94%B1%E5%89%8D%E7%BC%80%E6%98%A0%E5%B0%84"><span class="toc-number">2.4.2.</span> <span class="toc-text">根据目录自动路由前缀映射</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AutoPrefixConfigration-%E9%80%9A%E8%BF%87config%E6%B3%A8%E5%85%A5"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">AutoPrefixConfigration 通过config注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AutoPrefixUrlMapping-%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%E6%98%A0%E5%B0%84%E7%9A%84%E7%B1%BB"><span class="toc-number">2.4.2.2.</span> <span class="toc-text">AutoPrefixUrlMapping 处理请求映射的类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-Post%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C-Spring%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">2.4.3.</span> <span class="toc-text">Java Post参数校验 + Spring全局异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#controller-2"><span class="toc-number">2.4.3.1.</span> <span class="toc-text">controller</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DTO-%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3"><span class="toc-number">2.4.3.2.</span> <span class="toc-text">DTO 使用自定义注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3"><span class="toc-number">2.4.3.3.</span> <span class="toc-text">自定义注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E5%99%A8-%E5%AE%9E%E7%8E%B0-ConstraintValidator-%E6%8E%A5%E5%8F%A3"><span class="toc-number">2.4.3.4.</span> <span class="toc-text">注解处理器 实现 ConstraintValidator 接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86-2"><span class="toc-number">2.4.3.5.</span> <span class="toc-text">全局异常处理</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/%E4%BA%8C%E7%BA%A7%E5%B8%82%E5%9C%BA/%E8%80%83%E8%AF%95/%E5%9F%BA%E4%BB%8E/" title="基金从业资格证">基金从业资格证</a><time datetime="2024-06-01T16:00:00.000Z" title="发表于 2024-06-02 00:00:00">2024-06-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/Dev/language/small-language/YAML1.2/" title="YAML">YAML</a><time datetime="2024-04-19T16:00:00.000Z" title="发表于 2024-04-20 00:00:00">2024-04-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/articles/Dev/%E6%9C%8D%E5%8A%A1%E4%B8%AD%E9%97%B4%E4%BB%B6/Web%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/" title="Nginx"><img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting2/img/2023_09_25_08_26_56.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nginx"/></a><div class="content"><a class="title" href="/articles/Dev/%E6%9C%8D%E5%8A%A1%E4%B8%AD%E9%97%B4%E4%BB%B6/Web%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/" title="Nginx">Nginx</a><time datetime="2024-03-17T16:00:00.000Z" title="发表于 2024-03-18 00:00:00">2024-03-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/articles/Dev/design-patterns/%E7%BB%93%E6%9E%84%E5%9E%8B/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F/" title="桥接模式"><img src="https://refactoringguru.cn/images/patterns/diagrams/bridge/structure-zh.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="桥接模式"/></a><div class="content"><a class="title" href="/articles/Dev/design-patterns/%E7%BB%93%E6%9E%84%E5%9E%8B/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F/" title="桥接模式">桥接模式</a><time datetime="2024-03-12T16:00:00.000Z" title="发表于 2024-03-13 00:00:00">2024-03-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/articles/Dev/design-patterns/%E5%88%9B%E5%BB%BA%E5%9E%8B/%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/" title="抽象工厂模式"><img src="https://cdn.jsdelivr.net/gh/ChenXiangcheng1/image-hosting2/img/2024_0308_133937.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="抽象工厂模式"/></a><div class="content"><a class="title" href="/articles/Dev/design-patterns/%E5%88%9B%E5%BB%BA%E5%9E%8B/%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/" title="抽象工厂模式">抽象工厂模式</a><time datetime="2024-03-07T16:00:00.000Z" title="发表于 2024-03-08 00:00:00">2024-03-08</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/default_top_img.png')"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By Nemesis</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="/js/tw_cn.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(()=>{
  const getGiscusTheme = theme => {
    return theme === 'dark' ? 'dark' : 'light'
  }

  const loadGiscus = () => {
    const config = Object.assign({
      src: 'https://giscus.app/client.js',
      'data-repo': 'ChenXiangcheng1/chenxiangcheng1.github.io',
      'data-repo-id': 'R_kgDOJEy5Dw',
      'data-category-id': 'DIC_kwDOJEy5D84CfyxF',
      'data-mapping': 'pathname',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true
    },{"data-mapping":"title","data-input-position":"bottom"})

    const ele = document.createElement('script')
    for (let key in config) {
      ele.setAttribute(key, config[key])
    }
    document.getElementById('giscus-wrap').appendChild(ele)
  }

  const changeGiscusTheme = theme => {
    const sendMessage = message => {
      const iframe = document.querySelector('iframe.giscus-frame')
      if (!iframe) return
      iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app')
    }

    sendMessage({
      setConfig: {
        theme: getGiscusTheme(theme)
      }
    });
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if ('Giscus' === 'Giscus' || !true) {
    if (true) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment= loadGiscus
  }
})()</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script async data-pjax src="https://cdn.jsdelivr.net/gh/Pil0tXia/busuanzi-modified/busuanzi.pure.mini.js"></script></div></body></html>